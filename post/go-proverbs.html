<!doctype html>
<html lang="en"> <head> <title>A Coder @ Work</title> <meta http-equiv="content-type" content="text/html; charset=UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1"> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" /> <link href="//fonts.googleapis.com/css?family=Vollkorn:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css" /> <link href="//fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /> <link href= "https://lingchao.xin/css/style.css" rel="stylesheet" type="text/css" /> <link rel="alternate" href="https://lingchao.xin/rss.xml" type="application/rss+xml" /> <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-47053188-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script> </head> <body> <div class="navigation"> <a href="https://lingchao.xin">A Coder @ Work</a> | <a href="https://twitter.com/douglarek">Twitter</a>  | <a href="https://github.com/douglarek">Code</a>  | <a href="https://lingchao.xin/rss.xml">Rss</a>  </div> <div id="content"> <div class="article-meta">
<h1 class="title">Go è°šè¯­</h1>
<div class="tags">
Tagged as <a href="https://lingchao.xin/tag/go.html">go</a> </div>
<div class="date">
Written on 2018-01-28 09:25:04 </div>
</div>
<div class="article-content">
<p>æœ¬æ–‡è¯‘è‡ª<a href="http://go-proverbs.github.io/" >go-proverbs</a>, è„±èƒäº Rob Pike æŒ¯å¥‹äººå¿ƒçš„æ¼”è®²è§†é¢‘ <a href="https://www.youtube.com/watch?v=PAAkCSZUG1c" >talk at Gopherfest SV 2015</a> (<a href="https://www.bilibili.com/video/av18889438/" >bilibili</a>).</p>

<h4>ä¸è¦é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡, é€šè¿‡é€šä¿¡å…±äº«å†…å­˜ (<a href="https://www.bilibili.com/video/av18889438/?t=2m48s" >Don't communicate by sharing memory, share memory by communicating</a>)</h4>

<p>ä¼ ç»Ÿçš„çº¿ç¨‹æ¨¡å‹ï¼ˆé€šå¸¸åœ¨ç¼–å†™ Java, C++ å’Œ Python ç¨‹åºæ—¶ä½¿ç”¨ï¼‰è¦æ±‚ç¨‹åºå‘˜ä½¿ç”¨å…±äº«å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡.
é€šå¸¸, å…±äº«æ•°æ®ç»“æ„å—é”ä¿æŠ¤, çº¿ç¨‹å°†äº‰å¤ºè¿™äº›é”è®¿é—®æ•°æ®, åœ¨æŸäº›æƒ…å†µä¸‹, é€šè¿‡ä½¿ç”¨ Python çš„ Queue ç­‰çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„å¯ä»¥ä½¿è¿™å˜å¾—æ›´å®¹æ˜“.</p>

<p>Go çš„å¹¶å‘åŸè¯­ (goroutines å’Œ channels) ä¸ºæ„é€ å¹¶å‘è½¯ä»¶æä¾›äº†ä¸€ç§ä¼˜é›…è€Œç‹¬ç‰¹çš„æ‰‹æ®µ.
(è¿™äº›æ¦‚å¿µæœ‰ä¸€ä¸ªæœ‰è¶£çš„å†å², è¦ä» C.A.R.Hoare çš„é€šä¿¡é¡ºåºè¿›ç¨‹è¯´èµ·.) Go é¼“åŠ±ä½¿ç”¨ channels åœ¨ goroutines ä¹‹é—´ä¼ é€’å¯¹æ•°æ®çš„å¼•ç”¨, è€Œä¸æ˜¯æ˜¾å¼åœ°ä½¿ç”¨é”æ¥è°ƒè§£å¯¹å…±äº«æ•°æ®çš„è®¿é—®.
è¿™ç§æ–¹æ³•ç¡®ä¿åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥åœ¨ç»™å®šçš„æ—¶é—´è®¿é—®æ•°æ®. è¿™ä¸ªæ¦‚å¿µæ€»ç»“åœ¨ Effective Go æ–‡æ¡£ä¸­ (ä»»ä½• Go ç¨‹åºå‘˜éƒ½å¿…é¡»é˜…è¯»).</p>

<p>Go å®˜æ–¹åšå®¢ä¸­æœ‰ä¸€ç¯‡æ–‡ç« å¯¹è¯¥è°šè¯­è§£è¯», å¯ä»¥å‚è§<a href="https://blog.golang.org/share-memory-by-communicating" >åŸæ–‡</a>.</p>

<h4>å¹¶å‘ä¸æ˜¯å¹¶è¡Œ (<a href="https://www.bilibili.com/video/av18889438/?t=3m42s" >Concurrency is not parallelism</a>)</h4>

<p>å½“äººä»¬å¬åˆ° <em>å¹¶å‘</em> è¿™ä¸ªè¯çš„æ—¶å€™, ä»–ä»¬ç»å¸¸ä¼šæƒ³åˆ°å¹¶è¡Œ, è¿™æ˜¯ä¸€ä¸ªç›¸å…³çš„, ä½†éå¸¸ç‹¬ç‰¹çš„æ¦‚å¿µ. åœ¨ç¼–ç¨‹ä¸­, å¹¶å‘æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„è¿›ç¨‹çš„ç»„æˆ, è€Œå¹¶è¡Œåˆ™æ˜¯ (å¯èƒ½ç›¸å…³çš„) è®¡ç®—çš„åŒæ—¶æ‰§è¡Œ. å¹¶å‘æ˜¯ä¸€æ¬¡å¤„ç†å¾ˆå¤šäº‹æƒ…. å¹¶è¡Œæ˜¯ä¸€æ¬¡åšå¾ˆå¤šäº‹æƒ….</p>

<h4>Channels é‡æ’åº; äº’æ–¥é‡ä¸²è¡ŒåŒ– (<a href="https://www.bilibili.com/video/av18889438/?t=4m20s" >Channels orchestrate; mutexes serialize</a>)</h4>

<p>è¿™ä¸ªçœ‹ä¸­æ–‡ï¼ˆç¿»è¯‘å¾…å•†æ¦·ï¼‰æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µ (è™½ç„¶è‹±æ–‡ä¹Ÿçœ‹ä¸æ‡‚) ? å…¶å®åˆ†å·å‰åè¯´çš„æ˜¯ä¸€ä¸ªæ„æ€, è¯¥è°šè¯­æŒ‰æˆ‘çš„ä¸ªäººç†è§£å¯ä»¥ç”¨ go ç¨‹åº (æ¥è‡ª <a href="https://github.com/golang/tour/blob/master/content/concurrency/channels.go" >go tour</a>) è§£é‡Šæˆå¦‚ä¸‹:</p>

<pre><code>package main

import "fmt"

func sum(s []int, c chan int) {
    sum := 0
    for _, v := range s {
        sum += v
    }
    c &lt;- sum // æ­¤å¤„å¦‚æœæ”¹æˆäº’æ–¥é‡ä¸€æ ·å¯ä»¥åšåˆ°
}

func main() {
    s := []int{7, 2, 8, -9, 4, 0}

    c := make(chan int)
    go sum(s[:len(s)/2], c)
    go sum(s[len(s)/2:], c)
    x, y := &lt;-c, &lt;-c

    fmt.Println(x, y, x+y)
}</code></pre>

<h4>æ¥å£è¶Šå¤§, æŠ½è±¡è¶Šå¼± (<a href="https://www.bilibili.com/video/av18889438/?t=5m17s" >The bigger the interface, the weaker the abstraction</a>)</h4>

<p>æ¥å£èƒŒåçš„æ¦‚å¿µæ˜¯é€šè¿‡å°†å¯¹è±¡çš„è¡Œä¸ºæŠ½è±¡ä¸ºç®€å•çš„å¥‘çº¦æ¥å…è®¸é‡ç”¨æ€§. è™½ç„¶æ¥å£ä¸æ˜¯ Go ä¸“æœ‰çš„, ä½†ç”±äº Go æ¥å£é€šå¸¸è¶‹å‘äºå°å‹åŒ–, Go ç¨‹åºå‘˜æ‰å¹¿æ³›ä½¿ç”¨å®ƒä»¬. é€šå¸¸æƒ…å†µä¸‹, ä¸€ä¸ªæ¥å£åªé™äºä¸€åˆ°ä¸¤ä¸ªæ–¹æ³•.</p>

<p>Go io åŒ…æ¥å£å°±æ˜¯å…¸å‹çš„ä¾‹å­.</p>

<h4>å……åˆ†åˆ©ç”¨é›¶å€¼ (<a href="https://www.bilibili.com/video/av18889438/?t=6m25s" >Make the zero value useful</a>)</h4>

<p>é›¶å€¼çš„å…¸å‹ä¾‹å­å¦‚ bytes.Buffer å’Œ sync.Mutex:</p>

<pre><code>var buf bytes.Buffer
buf.Write([]byte("hello"))
fmt.Println(buf.String())

var mu sync.Mutex
mu.Lock()
mu.Unlock()</code></pre>

<p>è¿™æ ·çœ‹èµ·æ¥æ˜¯ä¸æ˜¯æ„Ÿè§‰ä¸€ç‚¹ç”¨æ²¡æœ‰ ? å¦‚æœè¿™æ ·å‘¢ ?</p>

<pre><code>type Map struct {
    mu sync.RWMutex
    // ...
}

func (m *Map) Set(k, v interface{}) {
    m.mu.Lock()
    defer m.mu.Unlock()
    if m.m == nil {
        m.m = make(map[interface{}]interface{})
    }
    m.m[k] = v
}</code></pre>

<h4>interface{} è¨€ä¹‹æ— ç‰© (<a href="https://www.bilibili.com/video/av18889438/?t=7m36s" >interface{} says nothing</a>)</h4>

<p>è¯¥è°šè¯­ä¸æ˜¯è¯´ interface {} ä¸ä»£è¡¨ä»»ä½•ä¸œè¥¿, è€Œæ˜¯è¯´è¯¥ç±»å‹æ— é™æ€æ£€æŸ¥ä»¥åŠè°ƒç”¨æ—¶ä¿è¯, æ¯”å¦‚ä½ çš„ func æ¥æ”¶ä¸€ä¸ª interface{} ç±»å‹, ä½ å†™çš„æ—¶å€™æ˜¯å¯ç”¨çš„, ä½†æ˜¯æŸä¸ªæ—¶é—´ä½ è¿›è¡Œäº†ä»£ç é‡æ„å¯èƒ½åæ‰äº†.</p>

<h4>Gofmt çš„é£æ ¼æ²¡æœ‰äººå–œæ¬¢, ä½†æ˜¯ gofmt æ˜¯æ¯ä¸ªäººçš„æœ€çˆ± (<a href="https://www.bilibili.com/video/av18889438/?t=8m43s" >Gofmt's style is no one's favorite, yet gofmt is everyone's favorite</a>)</h4>

<p>è¯¥è°šè¯­å‘Šè¯‰æˆ‘ä»¬å°‘äº›é£æ ¼ä¹‹äº‰, ç”¨è¿™äº›æ—¶é—´å¤šå†™ä»£ç .</p>

<h4>å°å¤åˆ¶å¥½è¿‡å°ä¾èµ– (<a href="https://www.bilibili.com/video/av18889438/?t=9m28s" >A little copying is better than a little dependency</a>)</h4>

<p>ç®€å•è¯´å°±æ˜¯å¦‚æœä½ å¯ä»¥æ‰‹åŠ¨æ’¸å°å¿«ä»£ç å°±ä¸è¦å¯¼å…¥ä¸€ä¸ªåº“å»åš, æ¯”å¦‚ UUID:</p>

<pre><code>// see: https://groups.google.com/d/msg/golang-nuts/d0nF_k4dSx4/rPGgfXv6QCoJ
package main

import (
    "fmt"
    "os"
)

func main() {
    f, _ := os.Open("/dev/urandom") // æ¼”ç¤ºç”¨å¿½ç•¥ errcheck
    b := make([]byte, 16)
    f.Read(b)
    f.Close()
    uuid := fmt.Sprintf("%x-%x-%x-%x-%x", b[0:4], b[4:6], b[6:8], b[8:10], b[10:])
    fmt.Println(uuid)
}</code></pre>

<p>è™½ç„¶æœ‰ä¸€å †å†™å¥½çš„ UUID åº“, å½“ä½ ä»…ä»…éœ€è¦ä¸€ä¸ª UUID v4 å®ç°.</p>

<h4>ç³»ç»Ÿè°ƒç”¨å¿…é¡»å§‹ç»ˆä½¿ç”¨æ„å»ºæ ‡ç­¾ä¿è¯ (<a href="https://www.bilibili.com/video/av18889438/?t=11m10s" >Syscall must always be guarded with build tags</a>)</h4>

<p>ä¸åŒçš„ç³»ç»Ÿ (*NIX, Windows) è°ƒç”¨å¯¼è‡´ä½ åŒä¸€ä¸ª func (å®ç°å¹¶ä¸ä¸€æ ·) å¯èƒ½éœ€è¦åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šæ„å»ºæ‰èƒ½å¾—åˆ°ä½ æƒ³è¦çš„ç»“æœ. ç®€å•è¯´å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ä¸å¯ç§»æ¤æ‰è¿™ä¹ˆå¹². ç¤ºä¾‹å¯å‚è§ Go æ ‡å‡†åº“ syscall.</p>

<h4>Cgo å¿…é¡»å§‹ç»ˆä½¿ç”¨æ„å»ºæ ‡ç­¾ä¿è¯ (<a href="https://www.bilibili.com/video/av18889438/?t=11m53s" >Cgo must always be guarded with build tags</a>)</h4>

<p>åŸºæœ¬ä¸ŠåŸå› åŒä¸Šä¸€æ¡.</p>

<h4>Cgo ä¸æ˜¯ Go (<a href="https://www.bilibili.com/video/av18889438/?t=12m37s" >Cgo is not Go</a>)</h4>

<p>å¦‚æœå¯èƒ½ä¸è¦ç”¨ Cgo. è¿™é‡Œæœ‰ç¯‡<a href="https://dave.cheney.net/2016/01/18/cgo-is-not-go" >æ–‡ç« </a>è¯´æ˜äº†ä¸ºä»€ä¹ˆ.</p>

<h4>unsafe åŒ…æ— ä¿è¯ (With the unsafe package there are no guarantees)</h4>

<p>åŒ…å¦‚å…¶å, ä¸å®‰å…¨. ä½ å¯ä»¥ä½¿ç”¨ unsafe åŒ…å¦‚æœä½ å‡†å¤‡å¥½äº†æœ‰ä¸€å¤©å®ƒä¼šåæ‰.</p>

<h4>æ¸…æ™°å¥½è¿‡èªæ˜ (<a href="https://www.bilibili.com/video/av18889438/?t=14m35s" >Clear is better than clever</a>)</h4>

<p>Rob Pike åœ¨ä»–ä¸åˆ«äººåˆè‘—çš„ &lt;<a href="https://item.jd.com/11836053.html" >ç¨‹åºè®¾è®¡å®è·µ</a>&gt; ä¸­å†™åˆ°: &quot;å†™æ¸…æ™°çš„ä»£ç , ä¸è¦å†™èªæ˜çš„ä»£ç &quot;.</p>

<h4>åå°„æ°¸è¿œä¸æ˜¯æ¸…æ™°çš„ (<a href="https://www.bilibili.com/video/av18889438/?t=15m22s" >Reflection is never clear</a>)</h4>

<p>å¾ˆå¤šäººåœ¨ Stackoverflow ä¸ŠæŠ±æ€¨ Go çš„åå°„ä¸å·¥ä½œ, å› ä¸ºé‚£ä¸æ˜¯ä¸ºä½ å‡†å¤‡çš„ğŸ˜‚! åªæœ‰å¾ˆå°‘å¾ˆå°‘çš„äººåº”è¯¥ç”¨åå°„è¿™ä¸ªéå¸¸å¼ºå¤§è€Œåˆéå¸¸éš¾çš„ç‰¹æ€§. æ–°æ‰‹åº”è¯¥è¿œç¦»åå°„å’Œ interface{}.</p>

<h4>é”™è¯¯ä¹Ÿæ˜¯ä¸€ç§å€¼ (<a href="https://www.bilibili.com/video/av18889438/?t=16m13s" >Errors are values</a>)</h4>

<p>å€¼å¯ä»¥è¢«ç¼–ç¨‹, å¹¶ä¸”ç”±äºé”™è¯¯æ˜¯å€¼, æ‰€ä»¥é”™è¯¯å¯ä»¥è¢«ç¼–ç¨‹. Go å®˜æ–¹åšå®¢æœ‰å¯¹æ­¤çš„<a href="https://blog.golang.org/errors-are-values" >è§£è¯»</a>.</p>

<h4>ä¸è¦æ­¢æ­¥äºæ£€æŸ¥é”™è¯¯è€Œè¦ä¼˜é›…çš„å¤„ç† (<a href="https://www.bilibili.com/video/av18889438/?t=17m25s" >Don't just check errors, handle them gracefully</a>)</h4>

<p>Dave Cheney æœ‰ç¯‡<a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" >åšå®¢</a>è¯¦ç»†è§£è¯»äº†è¯¥è°šè¯­.</p>

<h4>è®¾è®¡æ¶æ„, å‘½åç»„ä»¶, è®°å½•ç»†èŠ‚ (<a href="https://www.bilibili.com/video/av18889438/?t=18m09s" >Design the architecture, name the components, document the details</a>)</h4>

<p>å½“ä½ å†™ä¸€ä¸ªå¤§å‹ç³»ç»Ÿçš„æ—¶å€™, ä½ æŠŠå®ƒè®¾è®¡æˆä¸€ç§ç»“æ„åŒ–çš„ä¸œè¥¿. æƒ³è±¡ç»„ä»¶çš„æ¯ä¸€ä¸ªéƒ¨åˆ†å¹¶è¡Œå·¥ä½œ, ä¸ºä¸åŒçš„ç»„ä»¶èµ·å¥½çš„åå­—, å› ä¸ºè¿™äº›åå­—ä¼šå‡ºç°åœ¨ç¨¿çº¸ä¸Š.</p>

<p>æ‹¿ Go ç¨‹åºæ¥è¯´, å¦‚æœåå­—ä¸é”™, ç»„ä»¶å°±å¥½ç†è§£, é‚£ä¹ˆç¨‹åºçš„ç»“æ„è®¾è®¡å°±ä¼šæ¸…æ™°, ç¨‹åºä¼šæ„Ÿè§‰å¾ˆè‡ªç„¶.</p>

<p>ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šä¸œè¥¿ä½ éœ€è¦è§£é‡Š, æ‰€ä»¥è¿™äº›æ˜¯ä½ éœ€è¦è§£é‡Šçš„ç»†èŠ‚. ä½†æ˜¯å‘½åä¼šå¸®åŠ©ä½ è§£é‡Šå¾ˆå¤§ä¸€éƒ¨åˆ†è®¾è®¡. ç»†èŠ‚åªæ˜¯å¡«è¡¥ææ–™çš„ç¼ºå£å¯èƒ½ç”¨æ¥ä¸ºç”¨æˆ·æ‰“å°å·¥ç¨‹å›¾è§£æ–‡æ¡£.</p>

<h4>æ–‡æ¡£æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ (<a href="https://www.bilibili.com/video/av18889438/?t=19m07s" >Documentation is for users</a>)</h4>

<p>å¾ˆå¤šäººå†™æ–‡æ¡£è¡¨æ˜æŸä¸ª func æ˜¯åšä»€ä¹ˆçš„, ä½†æ˜¯ä»–ä»¬ä¸æƒ³æƒ³è¿™ä¸ª func æ˜¯ä¸ºè°è€Œå†™. è¿™æœ‰å¾ˆå¤§çš„ä¸åŒ. ä½ çŸ¥é“è¿™ä¸ª func è¿”å›ä»€ä¹ˆæ˜¯å¯¹çš„, ä½†æ˜¯å®ƒä¸ºä»€ä¹ˆè¿”å›äº†ä½ ä½¿ç”¨çš„æ—¶å€™ä¸ä¸€æ ·çš„ç»“æœ?</p>

<p>æŠŠè‡ªå·±å½“æˆä½¿ç”¨è€…è€Œä¸æ˜¯å†™å®ƒçš„äºº, é‚£ä¹ˆ godoc ä¸Šçš„æ–‡æ¡£å°±æ˜¯å¯¹ç”¨æˆ·æœ‰ç”¨çš„. è¿™å¯¹äºå…¶ä»–è¯­è¨€ä¸€æ ·é€‚ç”¨.</p>

<h4>ä¸è¦æ…Œ (<a href="https://github.com/golang/go/wiki/CodeReviewComments#dont-panic" >Don't panic</a>)</h4>

<p>ä¸è¦ä½¿ç”¨ panic è¿›è¡Œæ­£å¸¸çš„é”™è¯¯å¤„ç†. ä½¿ç”¨é”™è¯¯ (error) å’Œå¤šä¸ªè¿”å›å€¼.</p>
 </div>
<div class="relative-nav">
<a href="https://lingchao.xin/post/how-does-the-golang-scheduler-work.html">Previous</a><br>
<a href="https://lingchao.xin/post/gos-work-stealing-scheduler.html">Next</a><br>
</div>
 </div> <script type="text/javascript">
   var disqus = {
   load : function disqus(){
       var disqus_shortname = 'douglarek';
       if(typeof DISQUS !== 'object') {
         (function () {
         var s = document.createElement('script'); s.async = true;
         s.type = 'text/javascript';
         s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
         }());
	 document.getElementById('load-disqus').remove();
       }
       return true;
   }
   }
</script>
<a href="#disqus_thread" onclick="return disqus.load();" id="load-disqus">
Load Disqus
</a>
<div id="disqus_thread"></div> <div class="fineprint"> <hr> Unless otherwise credited all material <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US"> <img alt="Creative Commons License" style="border-width:0" src="https://lingchao.xin/css/cc-by-sa.png" /> </a> by Lingchao Xin <a id="coleslaw-logo" href="https://github.com/redline6561/coleslaw"> <img src="https://lingchao.xin/css/logo_small.jpg" alt="Coleslaw logo" /> </a> </div> </body> </html>