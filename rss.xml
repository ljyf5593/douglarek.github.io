<?xml version="1.0"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"> <channel> <title>A Coder @ Work</title> <link>https://lingchao.xin</link> <atom:link href="https://lingchao.xin/rss.xml" rel="self" type="application/rss+xml" /> <language>en-us</language> <pubDate>Thu, 01 Feb 2018 09:55:30 +0800</pubDate> <item> <title>Go å‡½æ•°å¼é€‰é¡¹æ¨¡å¼</title> <link>https://lingchao.xin/post/functional-options-pattern-in-go.html</link> <pubDate>2018-02-01 12:00:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/functional-options-pattern-in-go.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª <a href="https://halls-of-valhalla.org/beta/articles/functional-options-pattern-in-go,54/" >Functional Options Pattern in Go</a> ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰.
<!--more--></p>

<p>Golang å¼€å‘è€…é‡åˆ°çš„è®¸å¤šé—®é¢˜ä¹‹ä¸€æ˜¯å°è¯•å°†ä¸€ä¸ªå‡½æ•°çš„å‚æ•°è®¾ç½®ä¸ºå¯é€‰. è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„ç”¨ä¾‹, æœ‰äº›å¯¹è±¡åº”è¯¥ä½¿ç”¨ä¸€äº›åŸºæœ¬çš„é»˜è®¤è®¾ç½®æ¥å¼€ç®±å³ç”¨, å¹¶ä¸”ä½ å¶å°”å¯èƒ½éœ€è¦æä¾›ä¸€äº›æ›´è¯¦ç»†çš„é…ç½®.</p>

<p>åœ¨å¾ˆå¤šè¯­è¨€ä¸­è¿™å¾ˆå®¹æ˜“; åœ¨ C æ—è¯­è¨€ä¸­, å¯ä»¥ä½¿ç”¨ä¸åŒæ•°é‡çš„å‚æ•°æä¾›ç›¸åŒå‡½æ•°çš„å¤šä¸ªç‰ˆæœ¬; åœ¨åƒ PHP è¿™æ ·çš„è¯­è¨€ä¸­, å¯ä»¥ç»™å‚æ•°ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå¹¶åœ¨è°ƒç”¨æ–¹æ³•æ—¶å¿½ç•¥å®ƒä»¬. ä½†æ˜¯åœ¨ Golang ä¸­, è¿™ä¸¤ç§æ–¹å¼ä½ å“ªä¸ªä¹Ÿç”¨ä¸äº†. é‚£ä¹ˆä½ å¦‚ä½•åˆ›å»ºä¸€ä¸ªå‡½æ•°, ç”¨æˆ·å¯ä»¥æŒ‡å®šä¸€äº›é¢å¤–çš„é…ç½®?</p>

<p>æœ‰å¾ˆå¤šå¯èƒ½çš„æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹, ä½†æ˜¯å¤§å¤šæ•°éƒ½ä¸èƒ½æ»¡è¶³è¦æ±‚, æˆ–è€…éœ€è¦åœ¨æœåŠ¡ç«¯çš„ä»£ç ä¸­è¿›è¡Œé¢å¤–çš„æ£€æŸ¥å’ŒéªŒè¯, æˆ–è€…é€šè¿‡ä¼ é€’é¢å¤–çš„å®¢æˆ·ç«¯ä¸å…³å¿ƒçš„å‚æ•°æ¥ä¸ºå®¢æˆ·ç«¯åšé¢å¤–çš„å·¥ä½œ.</p>

<p>æˆ‘å°†ä»‹ç»ä¸€äº›ä¸åŒçš„æ–¹æ¡ˆ, å¹¶è¯´æ˜ä¸ºä»€ä¹ˆæ¯ä¸ªéƒ½ä¸æ˜¯æœ€ç†æƒ³çš„, ç„¶åæˆ‘ä»¬å°†å»ºç«‹æˆ‘ä»¬è‡ªå·±çš„æ–¹å¼æ¥ä½œä¸ºæœ€ç»ˆå¹²å‡€çš„è§£å†³æ–¹æ¡ˆ: å‡½æ•°å¼é€‰é¡¹æ¨¡å¼ (Functional Options Patter).</p>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­. æ¯”æ–¹è¯´, æˆ‘ä»¬æœ‰ä¸€äº›åä¸º StuffClient çš„æœåŠ¡, å®ƒæœ‰ä¸€äº›ä¸œè¥¿, å¹¶æœ‰ä¸¤ä¸ªé…ç½®é€‰é¡¹(timeout å’Œ retries):</p>

<pre><code>type StuffClient interface {
    DoStuff() error
}
type stuffClient struct {
    conn    Connection
    timeout int
    retries int
}</code></pre>

<p>ç»“æ„ä½“ stuffClient æ˜¯ç§æœ‰çš„, æ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä¸ºå®ƒæä¾›ä¸€äº›æ„é€ å™¨:</p>

<pre><code>func NewStuffClient(conn Connection, timeout, retries int) StuffClient {
    return &stuffClient{
        conn:    conn,
        timeout: timeout,
        retries: retries,
    }
}</code></pre>

<p>å—¯, ä½†æ˜¯ç°åœ¨æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨ NewStuffClient æ—¶éƒ½è¦æä¾› timeout å’Œ retries. è€Œå¤§å¤šæ•°æ—¶å€™æˆ‘ä»¬åªæƒ³ä½¿ç”¨é»˜è®¤å€¼. æˆ‘ä»¬ä¸èƒ½ç”¨ä¸åŒçš„å‚æ•°æ•°é‡æ¥å®šä¹‰å¤šä¸ªç‰ˆæœ¬çš„ NewStuffClient, å¦åˆ™æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªç±»ä¼¼ &quot;NewStuffClient redeclared in this blockt&quot; çš„ç¼–è¯‘é”™è¯¯.</p>

<p>ä¸€ä¸ªæ–¹æ¡ˆæ˜¯åˆ›å»ºå¦ä¸€ä¸ªä¸åŒåç§°çš„æ„é€ å™¨:</p>

<pre><code>func NewStuffClient(conn Connection) StuffClient {
    return &stuffClient{
        conn:    conn,
        timeout: DEFAULT_TIMEOUT,
        retries: DEFAULT_RETRIES,
    }
}
func NewStuffClientWithOptions(conn Connection, timeout, retries int) StuffClient {
    return &stuffClient{
        conn:    conn,
        timeout: timeout,
        retries: retries,
    }
}</code></pre>

<p>ä½†æ˜¯, è¿™æœ‰ç‚¹è¹©è„š. æˆ‘ä»¬å¯ä»¥åšå¾—æ¯”è¿™æ›´å¥½. å¦‚æœæˆ‘ä»¬ä¼ å…¥äº†ä¸€ä¸ªé…ç½®å¯¹è±¡å‘¢:</p>

<pre><code>type StuffClientOptions struct {
    Retries int //number of times to retry the request before giving up
    Timeout int //connection timeout in seconds
}
func NewStuffClient(conn Connection, options StuffClientOptions) StuffClient {
    return &stuffClient{
        conn:    conn,
        timeout: options.Timeout,
        retries: options.Retries,
    }
}</code></pre>

<p>ä½†æ˜¯, è¿™ä¹Ÿä¸æ˜¯å¾ˆå¥½. ç°åœ¨æˆ‘ä»¬æ€»æ˜¯éœ€è¦åˆ›å»º StuffClientOptions, å¹¶ä¸”å³ä½¿æˆ‘ä»¬ä¸æƒ³æŒ‡å®šä»»ä½•é€‰é¡¹ä¹Ÿè¦ä¼ é€’å®ƒ. è€Œä¸”æˆ‘ä»¬ä¹Ÿæ²¡æœ‰è‡ªåŠ¨å¡«å……é»˜è®¤å€¼, é™¤éæˆ‘ä»¬åœ¨ä»£ç ä¸­æ·»åŠ äº†ä¸€å †æ£€æŸ¥, æˆ–è€…æˆ‘ä»¬å¯ä»¥ä¼ å…¥ä¸€ä¸ª DefaultStuffClientOptions å˜é‡ (ä¹Ÿä¸å¥½, å› ä¸ºå®ƒå¯ä»¥åœ¨ä¸€ä¸ªåœ°æ–¹ä¿®æ”¹å¯¼è‡´å…¶ä»–åœ°æ–¹æœ‰é—®é¢˜).</p>

<p>é‚£ä¹ˆè§£å†³æ–¹æ¡ˆæ˜¯ä»€ä¹ˆ? è§£å†³è¿™ä¸ªéš¾é¢˜æœ€å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨å‡½æ•°å¼é€‰é¡¹æ¨¡å¼, åˆ©ç”¨ Go å¯¹é—­åŒ…çš„æ–¹ä¾¿æ”¯æŒ. è®©æˆ‘ä»¬ç»§ç»­æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ StuffClientOptions, ä½†æ˜¯æˆ‘ä»¬ä¼šæ·»åŠ ä¸€äº›ä¸œè¥¿:</p>

<pre><code>type StuffClientOption func(*StuffClientOptions)
type StuffClientOptions struct {
    Retries int //number of times to retry the request before giving up
    Timeout int //connection timeout in seconds
}
func WithRetries(r int) StuffClientOption {
    return func(o *StuffClientOptions) {
        o.Retries = r
    }
}
func WithTimeout(t int) StuffClientOption {
    return func(o *StuffClientOptions) {
        o.Timeout = t
    }
}</code></pre>

<p>æ³¥åœŸèˆ¬èŠ¬èŠ³, å¯¹å§? ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆ? åŸºæœ¬ä¸Šæˆ‘ä»¬æœ‰æˆ‘ä»¬çš„ç»“æ„å®šä¹‰æˆ‘ä»¬çš„ StuffClient çš„å¯ç”¨é€‰é¡¹. å¦å¤–ç°åœ¨æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º StuffClientOption çš„ä¸œä¸œ(è¿™æ¬¡æ˜¯å•æ•°), å®ƒåªæ˜¯ä¸€ä¸ªæ¥å—æˆ‘ä»¬çš„é€‰é¡¹ struct ä½œä¸ºå‚æ•°çš„å‡½æ•°. æˆ‘ä»¬å·²ç»å®šä¹‰äº†å¦å¤–ä¸€äº›å‡½æ•° WithRetries å’Œ WithTimeout, å®ƒä»¬è¿”å›ä¸€ä¸ªé—­åŒ…. ç°åœ¨é­”æ³•é™ä¸´:</p>

<pre><code>var defaultStuffClientOptions = StuffClientOptions{
    Retries: 3,
    Timeout: 2,
}
func NewStuffClient(conn Connection, opts ...StuffClientOption) StuffClient {
    options := defaultStuffClientOptions
    for _, o := range opts {
        o(&options)
    }
    return &stuffClient{
        conn:    conn,
        timeout: options.Timeout,
        retries: options.Retries,
    }
}</code></pre>

<p>æˆ‘ä»¬å·²ç»å®šä¹‰äº†ä¸€ä¸ªé¢å¤–çš„æœªå¯¼å‡º(unexposed)å˜é‡, åŒ…å«æˆ‘ä»¬çš„é»˜è®¤é€‰é¡¹, æˆ‘ä»¬ç°åœ¨è°ƒæ•´äº†æˆ‘ä»¬çš„æ„é€ å‡½æ•°, è€Œä¸æ˜¯æ¥å—ä¸€ä¸ªå¯å˜å‚æ•°. ç„¶å, æˆ‘ä»¬éå† StuffClientOption (å•æ•°) åˆ—è¡¨, å¹¶å¯¹æ¯ä¸€é¡¹åº”ç”¨è¿”å›çš„é—­åŒ…åˆ°æˆ‘ä»¬çš„é€‰é¡¹å˜é‡.</p>

<p>ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯è¿™æ ·:</p>

<pre><code>x := NewStuffClient(Connection{})
fmt.Println(x) // prints &{{} 2 3}
x = NewStuffClient(
    Connection{},
    WithRetries(1),
)
fmt.Println(x) // prints &{{} 2 1}
x = NewStuffClient(
    Connection{},
    WithRetries(1),
    WithTimeout(1),
)
fmt.Println(x) // prints &{{} 1 1}</code></pre>

<p>è¿™çœ‹èµ·æ¥ç›¸å½“ä¸é”™è€Œä¸”å¯ç”¨. è€Œå…³äºå®ƒçš„å¥½çš„éƒ¨åˆ†æ˜¯, æˆ‘ä»¬å¯ä»¥éšæ—¶æ·»åŠ æ–°çš„é€‰é¡¹, åªéœ€è¦å¯¹ä»£ç è¿›è¡Œéå¸¸å°‘é‡çš„æ›´æ”¹. æŠŠè¿™äº›éƒ½ç»„åˆèµ·æ¥å°±æ˜¯è¿™æ ·:</p>

<pre><code>var defaultStuffClientOptions = StuffClientOptions{
    Retries: 3,
    Timeout: 2,
}
type StuffClientOption func(*StuffClientOptions)
type StuffClientOptions struct {
    Retries int //number of times to retry the request before giving up
    Timeout int //connection timeout in seconds
}
func WithRetries(r int) StuffClientOption {
    return func(o *StuffClientOptions) {
        o.Retries = r
    }
}
func WithTimeout(t int) StuffClientOption {
    return func(o *StuffClientOptions) {
        o.Timeout = t
    }
}
type StuffClient interface {
    DoStuff() error
}
type stuffClient struct {
    conn    Connection
    timeout int
    retries int
}
type Connection struct {}
func NewStuffClient(conn Connection, opts ...StuffClientOption) StuffClient {
    options := defaultStuffClientOptions
    for _, o := range opts {
        o(&options)
    }
        return &stuffClient{
            conn:    conn,
            timeout: options.Timeout,
            retries: options.Retries,
        }
}
func (c stuffClient) DoStuff() error {
    return nil
}</code></pre>

<p>å¦‚æœä½ æƒ³è‡ªå·±å°è¯•ä¸€ä¸‹, å» <a href="https://play.golang.org/p/VcWqWcAEyz" >Go Playground</a> å§.</p>

<p>ä½†æ˜¯å¯ä»¥é€šè¿‡åˆ é™¤ StuffClientOptions ç»“æ„å¹¶ç›´æ¥å°†é€‰é¡¹åº”ç”¨åˆ°æˆ‘ä»¬çš„ StuffClient æ¥è¿›ä¸€æ­¥ç®€åŒ–.</p>

<pre><code>var defaultStuffClient = stuffClient{
    retries: 3,
    timeout: 2,
}
type StuffClientOption func(*stuffClient)
func WithRetries(r int) StuffClientOption {
    return func(o *stuffClient) {
        o.retries = r
    }
}
func WithTimeout(t int) StuffClientOption {
    return func(o *stuffClient) {
        o.timeout = t
    }
}
type StuffClient interface {
    DoStuff() error
}
type stuffClient struct {
    conn    Connection
    timeout int
    retries int
}
type Connection struct{}
func NewStuffClient(conn Connection, opts ...StuffClientOption) StuffClient {
    client := defaultStuffClient
    for _, o := range opts {
        o(&client)
    }

    client.conn = conn
    return client
}
func (c stuffClient) DoStuff() error {
    return nil
}</code></pre>

<p>å¯ä»¥åœ¨<a href="https://play.golang.org/p/Z5P5Om4KDL" >è¿™é‡Œ</a>å°è¯•ä¸€ä¸‹. åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­, æˆ‘ä»¬åªæ˜¯ç›´æ¥å°†é…ç½®åº”ç”¨åˆ°æˆ‘ä»¬çš„ç»“æ„ä¸­, åœ¨ä¸­é—´æœ‰ä¸€ä¸ªé¢å¤–çš„é…ç½®ç»“æ„æ˜¯æ²¡æœ‰æ„ä¹‰çš„. ä½†æ˜¯è¯·æ³¨æ„, åœ¨è®¸å¤šæƒ…å†µä¸‹, æ‚¨å¯èƒ½ä»ç„¶æƒ³ä½¿ç”¨å‰é¢ç¤ºä¾‹ä¸­çš„ config ç»“æ„ä½“; ä¾‹å¦‚, å¦‚æœä½ çš„æ„é€ å™¨ä½¿ç”¨é…ç½®é€‰é¡¹æ¥æ‰§è¡Œä¸€äº›æ“ä½œ, ä½†ä¸æŠŠå®ƒä»¬å­˜å‚¨åˆ°ç»“æ„ä¸­, æˆ–è€…ä¼ é€’åˆ°å…¶ä»–åœ°æ–¹. é…ç½®ç»“æ„å˜ä½“æ˜¯æ›´é€šç”¨çš„å®ç°.</p>

<p>æ„Ÿè°¢ Rob Pike å’Œ Dave Cheney æ¨å¹¿è¿™ç§è®¾è®¡æ¨¡å¼.</p>
 ]]></description> </item><item> <title>Go work-stealing è°ƒåº¦å™¨</title> <link>https://lingchao.xin/post/gos-work-stealing-scheduler.html</link> <pubDate>2018-01-31 14:35:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/gos-work-stealing-scheduler.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª Rakyll çš„ <a href="https://rakyll.org/scheduler/" >scheduler</a>ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰.
<!--more--></p>

<p>Go è°ƒåº¦å™¨çš„å·¥ä½œæ˜¯å°†å¯è¿è¡Œçš„ goroutine åˆ†å‘åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œçš„å¤šä¸ªæ“ä½œç³»ç»Ÿå·¥ä½œçº¿ç¨‹.
åœ¨å¤šçº¿ç¨‹è®¡ç®—é‡Œ, è°ƒåº¦å‡ºç°äº†ä¸¤ç§æ¨¡å¼: work-sharing (å·¥ä½œå…±äº«) å’Œ work-stealing (å·¥ä½œçªƒå–).</p>

<ul>
<li><strong>work-sharing</strong> å½“ä¸€ä¸ªå¤„ç†å™¨äº§ç”Ÿæ–°çš„çº¿ç¨‹æ—¶, å®ƒè¯•å›¾å°†å…¶ä¸­çš„ä¸€äº›è¿ç§»åˆ°å…¶ä»–å¤„ç†å™¨ä¸Š, å¸Œæœ›å®ƒä»¬èƒ½è¢«ç©ºé—²æˆ–æœªå……åˆ†åˆ©ç”¨çš„å¤„ç†å™¨æ‰€åˆ©ç”¨.</li>
<li><strong>work-stealing</strong> æœªå……åˆ†åˆ©ç”¨çš„å¤„ç†å™¨ä¼šä¸»åŠ¨å»å¯»æ‰¾å…¶ä»–å¤„ç†å™¨çš„çº¿ç¨‹å¹¶ <code>çªƒå–</code> ä¸€äº›.</li>
</ul>

<p>work-stealing ä¸­çº¿ç¨‹è¿ç§»çš„é¢‘ç‡å°‘äº work-sharing. å½“æ‰€æœ‰å¤„ç†å™¨éƒ½æœ‰å·¥ä½œè¦è¿è¡Œæ—¶, æ²¡æœ‰çº¿ç¨‹ä¼šè¢«è¿ç§». è€Œä¸€æ—¦æœ‰ç©ºé—²çš„å¤„ç†å™¨, å°±ä¼šè€ƒè™‘è¿ç§».</p>

<p>Go ä» 1.1 å¼€å§‹å°±æœ‰ä¸€ä¸ª work-stealing çš„è°ƒåº¦å™¨, ç”± <a href="https://github.com/dvyukov" >Dmitry Vyukov</a> è´¡çŒ®. æœ¬æ–‡å°†æ·±å…¥è§£é‡Šä»€ä¹ˆæ˜¯ work-stealing è°ƒåº¦å™¨, ä»¥åŠ Go å¦‚ä½•å®ç°å®ƒ.</p>

<h4>è°ƒåº¦åŸºç¡€</h4>

<p>Go æœ‰ä¸€ä¸ªå¯ä»¥åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ M:N è°ƒåº¦å™¨. ä»»ä½•æ—¶å€™, M ä¸ª goroutine éƒ½éœ€è¦åœ¨ N ä¸ª OS çº¿ç¨‹ä¸Šè¿›è¡Œè°ƒåº¦, è¿™äº›çº¿ç¨‹è¿è¡Œåœ¨æœ€å¤š GOMAXPROCS æ•°é‡çš„å¤„ç†å™¨ä¸Š.
Go è°ƒåº¦å™¨ä½¿ç”¨ä»¥ä¸‹æœ¯è¯­è§£é‡Š goroutine, çº¿ç¨‹ä»¥åŠå¤„ç†å™¨:</p>

<ul>
<li>G: goroutine</li>
<li>M: OS çº¿ç¨‹ (æœºå™¨)</li>
<li>P: å¤„ç†å™¨ (è¯‘è€…: æ­¤å¤„ä¸æ˜¯æŒ‡ CPU, å¯ä»¥è®¤ä¸ºæ˜¯ Go è°ƒåº¦ä¸Šä¸‹æ–‡æˆ–è°ƒåº¦å¤„ç†å™¨, æ‰€ä»¥ä¸‹æ–‡çš„å¤„ç†å™¨å¦‚æ— ç‰¹åˆ«è¯´æ˜éƒ½æ˜¯æŒ‡ P)</li>
</ul>

<p>æœ‰ä¸€ä¸ª P ç›¸å…³çš„æœ¬åœ°å’Œå…¨å±€ goroutine é˜Ÿåˆ—. æ¯ä¸ª M åº”è¯¥è¢«åˆ†é…ç»™ä¸€ä¸ª P. å¦‚æœè¢«é˜»å¡æˆ–è€…åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­, P (ä»¬) å¯èƒ½æ²¡æœ‰ M (ä»¬). ä»»ä½•æ—¶å€™ï¼Œæœ€å¤šåªæœ‰ GOMAXPROCS æ•°é‡çš„ P. ä»»ä½•æ—¶å€™, æ¯ä¸ª P åªèƒ½æœ‰ä¸€ä¸ª M è¿è¡Œ. å¦‚æœéœ€è¦, æ›´å¤šçš„ M (ä»¬) å¯ä»¥ç”±è°ƒåº¦å™¨åˆ›å»º.</p>

<p><img src="/static/images/scheduler-concepts.png" width="782" height="358" /></p>

<p>æ¯è½®è°ƒåº¦åªæ˜¯ç®€å•æ‰¾åˆ°ä¸€ä¸ªå¯è¿è¡Œçš„ goroutine å¹¶æ‰§è¡Œå®ƒ. åœ¨æ¯è½®è°ƒåº¦ä¸­, æœç´¢æŒ‰ä»¥ä¸‹é¡ºåºè¿›è¡Œ:</p>

<pre><code>runtime.schedule() {
    // only 1/61 of the time, check the global runnable queue for a G. ä»… 1/61 çš„æ—¶é—´, æ£€æŸ¥å…¨å±€è¿è¡Œé˜Ÿåˆ—é‡Œé¢çš„ G.
    // if not found, check the local queue. å¦‚æœæ²¡æ‰¾åˆ°, æ£€æŸ¥æœ¬åœ°é˜Ÿåˆ—.
    // if not found, è¿˜æ˜¯æ²¡æ‰¾åˆ° ?
    //     try to steal from other Ps. å°è¯•ä»å…¶ä»– P å·.
    //     if not, check the global runnable queue. è¿˜æ˜¯æ²¡æœ‰, æ£€æŸ¥å…¨å±€è¿è¡Œé˜Ÿåˆ—.
    //     if not found, poll network. è¿˜æ˜¯æ²¡æœ‰, è½®è¯¢ç½‘ç»œ.
}</code></pre>

<p>ä¸€æ—¦æ‰¾åˆ°å¯è¿è¡Œçš„ G, å®ƒä¼šä¸€ç›´æ‰§è¡Œç›´åˆ°è¢«é˜»å¡.</p>

<p><strong>æ³¨æ„</strong> çœ‹èµ·æ¥å¥½åƒå…¨å±€é˜Ÿåˆ—æ¯”æœ¬åœ°é˜Ÿåˆ—æœ‰ä¼˜åŠ¿, ä½†æ˜¯å¶å°”æ£€æŸ¥å…¨å±€é˜Ÿåˆ—æ˜¯è‡³å…³é‡è¦çš„, ä»¥é¿å… M åªæ˜¯ä»æœ¬åœ°é˜Ÿåˆ—è°ƒåº¦, ç›´åˆ°æ²¡æœ‰æœ¬åœ°æ’é˜Ÿçš„ goroutine ç•™ä¸‹.</p>

<h4>Stealing (çªƒå–)</h4>

<p>å½“ä¸€ä¸ªæ–°çš„ G è¢«åˆ›å»ºæˆ–è€…ä¸€ä¸ªç°æœ‰çš„ G å˜æˆå¯è¿è¡Œçš„æ—¶å€™, å®ƒè¢«å‹å…¥å½“å‰ P çš„å¯è¿è¡Œçš„ goroutine åˆ—è¡¨. å½“ P å®Œæˆ G æ—¶, å®ƒä¼šå°è¯•ä»è‡ªå·±çš„å¯è¿è¡Œ goroutine åˆ—è¡¨ä¸­å¼¹å‡ºä¸€ä¸ª G. å¦‚æœåˆ—è¡¨ç°åœ¨æ˜¯ç©ºçš„, P ä¼šéšæœºçš„é€‰æ‹©å…¶ä»–çš„ P, å¹¶å°è¯•ä»å…¶é˜Ÿåˆ—ä¸­å·å–ä¸€åŠå¯è¿è¡Œçš„ goroutine(s).</p>

<p><img src="/static/images/scheduler-stealing.png" width="782" height="409" /></p>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­, P2 æ‰¾ä¸åˆ°ä»»ä½•å¯è¿è¡Œçš„ goroutine. å› æ­¤, å®ƒéšæœºé€‰æ‹©å¦ä¸€ä¸ª P1, å¹¶å°†å…¶ä¸‰ä¸ª goroutine(s) çªƒå–åˆ°è‡ªå·±çš„æœ¬åœ°é˜Ÿåˆ—ä¸­. P2 å°†èƒ½å¤Ÿè¿è¡Œè¿™äº› goroutine, å¹¶ä¸”è°ƒåº¦å™¨çš„å·¥ä½œä¼šåœ¨å¤šä¸ªå¤„ç†å™¨ä¹‹é—´æ›´åŠ å…¬å¹³åœ°åˆ†é….</p>

<h4>è‡ªæ—‹çº¿ç¨‹ (Spinning threads)</h4>

<p>è°ƒåº¦å™¨æ€»æ˜¯å¸Œæœ›å°†å°½å¯èƒ½å¤šçš„å¯è¿è¡Œçš„ goroutine(s) åˆ†é…ç»™ M (ä»¬) æ¥åˆ©ç”¨å¤„ç†å™¨, ä½†æ˜¯åŒæ—¶æˆ‘ä»¬éœ€è¦åœç•™è¿‡å¤šçš„å·¥ä½œæ¥èŠ‚çœ CPU å’Œç”µåŠ›. ä¸æ­¤ç›¸çŸ›ç›¾çš„æ˜¯, è°ƒåº¦å™¨è¿˜éœ€è¦èƒ½å¤Ÿæ‰©å±•åˆ°é«˜ååé‡å’Œ CPU å¯†é›†å‹çš„ç¨‹åº.
å¦‚æœæ€§èƒ½æ˜¯è‡³å…³é‡è¦çš„, é‚£ä¹ˆå¯¹é«˜ååé‡ç¨‹åºæ¥è¯´æŒç»­æŠ¢å æ—¢æ˜¯æ˜‚è´µåˆæ˜¯æœ‰é—®é¢˜çš„. æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸åº”è¯¥é¢‘ç¹åœ°åœ¨ goroutine(s) ä¹‹é—´åˆ‡æ¢, å› ä¸ºè¿™ä¼šå¢åŠ å»¶è¿Ÿ. é™¤æ­¤ä¹‹å¤–, åœ¨å‘ç”Ÿç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™, æ“ä½œç³»ç»Ÿçº¿ç¨‹éœ€è¦ä¸æ–­åœ°è¢«é˜»å¡å’Œè§£é™¤é˜»å¡. è¿™æ˜¯æ˜‚è´µçš„, å¹¶å¢åŠ äº†å¾ˆå¤šå¼€é”€.</p>

<p>ä¸ºäº†å°½é‡å‡å°‘åˆ‡æ¢, Go è°ƒåº¦å™¨å®ç°äº† <code>è‡ªæ—‹çº¿ç¨‹</code>. è‡ªæ—‹çº¿ç¨‹æ¶ˆè€—ä¸€ç‚¹é¢å¤–çš„ CPU, ä½†æ˜¯å®ƒä»¬æœ€å°åŒ–äº† OS çº¿ç¨‹çš„æŠ¢å . ä¸€ä¸ªçº¿ç¨‹æ˜¯è‡ªæ—‹çš„, å¦‚æœ:</p>

<ul>
<li>åˆ†é…äº† P çš„ M æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªå¯æ‰§è¡Œ goroutine;</li>
<li>æ²¡æœ‰åˆ†é… P çš„ M æ­£åœ¨å¯»æ‰¾å¯ç”¨çš„ P;</li>
<li>è°ƒåº¦å™¨è¿˜ä¼šé‡Šæ”¾ä¸€ä¸ªé™„åŠ çš„çº¿ç¨‹, å½“å®ƒæ­£å‡†å¤‡ä¸€ä¸ª goroutine å¹¶ä¸”æ²¡æœ‰ç©ºé—²çš„ P ä¹Ÿæ²¡æœ‰å…¶ä»–è‡ªæ—‹çº¿ç¨‹çš„æ—¶å€™è®©å®ƒè‡ªæ—‹.</li>
</ul>

<p>ä»»ä½•æ—¶å€™æœ€å¤šæœ‰ GOMAXPROCS ä¸ªè‡ªæ—‹çš„ M (ä»¬). å½“ä¸€ä¸ªè‡ªæ—‹çš„çº¿ç¨‹æ‰¾åˆ°å·¥ä½œ, å®ƒå°±è„±ç¦»äº†è‡ªæ—‹çŠ¶æ€.</p>

<p>å¦‚æœæœ‰ç©ºé—²çš„ M æ²¡æœ‰è¢«èµ‹äºˆ P, é‚£ä¹ˆè¢«èµ‹äºˆ P çš„ç©ºé—²çº¿ç¨‹ä¸ä¼šè¢«é˜»å¡. å½“æ–°çš„ goroutine(s) è¢«åˆ›å»ºæˆ– M è¢«é˜»å¡æ—¶, è°ƒåº¦å™¨ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªè‡ªæ—‹ M. è¿™ç¡®ä¿äº†æ²¡æœ‰å¯è¿è¡Œçš„ goroutine(s) ä¸è¢«è¿è¡Œ; å¹¶ä¸”é¿å…è¿‡å¤šçš„ M é˜»å¡æˆ–è€…è§£é™¤é˜»å¡.</p>

<h4>ç»“è®º</h4>

<p>Go è°ƒåº¦å™¨åšäº†å¾ˆå¤šäº‹æƒ…æ¥é¿å…è¿‡å¤šçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹æŠ¢å , é€šè¿‡çªƒå–(stealing)è°ƒåº¦å®ƒä»¬åˆ°æ­£ç¡®å’Œæœªå……åˆ†åˆ©ç”¨çš„å¤„ç†å™¨, ä»¥åŠå®ç° <code>è‡ªæ—‹</code> çº¿ç¨‹ä»¥é¿å…è¿‡é«˜é˜»å¡æˆ–è€…è§£é™¤é˜»å¡åˆ‡æ¢çš„å‘ç”Ÿ.</p>

<p>è°ƒåº¦äº‹ä»¶å¯ä»¥ç”¨æ‰§è¡Œè¿½è¸ªå™¨(<a href="https://golang.org/cmd/trace/" >execution tracer</a>)è¿½è¸ª. å¦‚æœä½ ç¢°å·§è®¤ä¸ºè‡ªå·±çš„å¤„ç†å™¨åˆ©ç”¨ç‡å¾ˆå·®, åˆ™å¯ä»¥ç”¨å®ƒæ¢ç©¶å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ….</p>

<h5>å‚è€ƒèµ„æ–™</h5>

<ul>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/proc.go" >Go è¿è¡Œæ—¶è°ƒåº¦å™¨æºç </a></li>
<li><a href="https://golang.org/s/go11sched" >å¯æ‰©å±• Go è°ƒåº¦å™¨è®¾è®¡æ–‡æ¡£</a></li>
<li><a href="https://morsmachine.dk/go-scheduler" >Daniel Morsing: Go è°ƒåº¦å™¨</a></li>
</ul>
 ]]></description> </item><item> <title>Go è°šè¯­</title> <link>https://lingchao.xin/post/go-proverbs.html</link> <pubDate>2018-01-28 09:25:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/go-proverbs.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª<a href="http://go-proverbs.github.io/" >go-proverbs</a>, è„±èƒäº Rob Pike æŒ¯å¥‹äººå¿ƒçš„æ¼”è®²è§†é¢‘ <a href="https://www.youtube.com/watch?v=PAAkCSZUG1c" >talk at Gopherfest SV 2015</a> (<a href="https://www.bilibili.com/video/av18889438/" >bilibili</a>).</p>

<h4>ä¸è¦é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œé€šä¿¡, é€šè¿‡é€šä¿¡å…±äº«å†…å­˜ (<a href="https://www.bilibili.com/video/av18889438/?t=2m48s" >Don't communicate by sharing memory, share memory by communicating</a>)</h4>

<p>ä¼ ç»Ÿçš„çº¿ç¨‹æ¨¡å‹ï¼ˆé€šå¸¸åœ¨ç¼–å†™ Java, C++ å’Œ Python ç¨‹åºæ—¶ä½¿ç”¨ï¼‰è¦æ±‚ç¨‹åºå‘˜ä½¿ç”¨å…±äº«å†…å­˜åœ¨çº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡.
é€šå¸¸, å…±äº«æ•°æ®ç»“æ„å—é”ä¿æŠ¤, çº¿ç¨‹å°†äº‰å¤ºè¿™äº›é”è®¿é—®æ•°æ®, åœ¨æŸäº›æƒ…å†µä¸‹, é€šè¿‡ä½¿ç”¨ Python çš„ Queue ç­‰çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„å¯ä»¥ä½¿è¿™å˜å¾—æ›´å®¹æ˜“.</p>

<p>Go çš„å¹¶å‘åŸè¯­ (goroutines å’Œ channels) ä¸ºæ„é€ å¹¶å‘è½¯ä»¶æä¾›äº†ä¸€ç§ä¼˜é›…è€Œç‹¬ç‰¹çš„æ‰‹æ®µ.
(è¿™äº›æ¦‚å¿µæœ‰ä¸€ä¸ªæœ‰è¶£çš„å†å², è¦ä» C.A.R.Hoare çš„é€šä¿¡é¡ºåºè¿›ç¨‹è¯´èµ·.) Go é¼“åŠ±ä½¿ç”¨ channels åœ¨ goroutines ä¹‹é—´ä¼ é€’å¯¹æ•°æ®çš„å¼•ç”¨, è€Œä¸æ˜¯æ˜¾å¼åœ°ä½¿ç”¨é”æ¥è°ƒè§£å¯¹å…±äº«æ•°æ®çš„è®¿é—®.
è¿™ç§æ–¹æ³•ç¡®ä¿åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥åœ¨ç»™å®šçš„æ—¶é—´è®¿é—®æ•°æ®. è¿™ä¸ªæ¦‚å¿µæ€»ç»“åœ¨ Effective Go æ–‡æ¡£ä¸­ (ä»»ä½• Go ç¨‹åºå‘˜éƒ½å¿…é¡»é˜…è¯»).</p>

<p>Go å®˜æ–¹åšå®¢ä¸­æœ‰ä¸€ç¯‡æ–‡ç« å¯¹è¯¥è°šè¯­è§£è¯», å¯ä»¥å‚è§<a href="https://blog.golang.org/share-memory-by-communicating" >åŸæ–‡</a>.</p>

<h4>å¹¶å‘ä¸æ˜¯å¹¶è¡Œ (<a href="https://www.bilibili.com/video/av18889438/?t=3m42s" >Concurrency is not parallelism</a>)</h4>

<p>å½“äººä»¬å¬åˆ° <em>å¹¶å‘</em> è¿™ä¸ªè¯çš„æ—¶å€™, ä»–ä»¬ç»å¸¸ä¼šæƒ³åˆ°å¹¶è¡Œ, è¿™æ˜¯ä¸€ä¸ªç›¸å…³çš„, ä½†éå¸¸ç‹¬ç‰¹çš„æ¦‚å¿µ. åœ¨ç¼–ç¨‹ä¸­, å¹¶å‘æ˜¯ç‹¬ç«‹æ‰§è¡Œçš„è¿›ç¨‹çš„ç»„æˆ, è€Œå¹¶è¡Œåˆ™æ˜¯ (å¯èƒ½ç›¸å…³çš„) è®¡ç®—çš„åŒæ—¶æ‰§è¡Œ. å¹¶å‘æ˜¯ä¸€æ¬¡å¤„ç†å¾ˆå¤šäº‹æƒ…. å¹¶è¡Œæ˜¯ä¸€æ¬¡åšå¾ˆå¤šäº‹æƒ….</p>

<h4>Channels é‡æ’åº; äº’æ–¥é‡ä¸²è¡ŒåŒ– (<a href="https://www.bilibili.com/video/av18889438/?t=4m20s" >Channels orchestrate; mutexes serialize</a>)</h4>

<p>è¿™ä¸ªçœ‹ä¸­æ–‡ï¼ˆç¿»è¯‘å¾…å•†æ¦·ï¼‰æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µ (è™½ç„¶è‹±æ–‡ä¹Ÿçœ‹ä¸æ‡‚) ? å…¶å®åˆ†å·å‰åè¯´çš„æ˜¯ä¸€ä¸ªæ„æ€, è¯¥è°šè¯­æŒ‰æˆ‘çš„ä¸ªäººç†è§£å¯ä»¥ç”¨ go ç¨‹åº (æ¥è‡ª <a href="https://github.com/golang/tour/blob/master/content/concurrency/channels.go" >go tour</a>) è§£é‡Šæˆå¦‚ä¸‹:</p>

<pre><code>package main

import "fmt"

func sum(s []int, c chan int) {
    sum := 0
    for _, v := range s {
        sum += v
    }
    c &lt;- sum // æ­¤å¤„å¦‚æœæ”¹æˆäº’æ–¥é‡ä¸€æ ·å¯ä»¥åšåˆ°
}

func main() {
    s := []int{7, 2, 8, -9, 4, 0}

    c := make(chan int)
    go sum(s[:len(s)/2], c)
    go sum(s[len(s)/2:], c)
    x, y := &lt;-c, &lt;-c

    fmt.Println(x, y, x+y)
}</code></pre>

<h4>æ¥å£è¶Šå¤§, æŠ½è±¡è¶Šå¼± (<a href="https://www.bilibili.com/video/av18889438/?t=5m17s" >The bigger the interface, the weaker the abstraction</a>)</h4>

<p>æ¥å£èƒŒåçš„æ¦‚å¿µæ˜¯é€šè¿‡å°†å¯¹è±¡çš„è¡Œä¸ºæŠ½è±¡ä¸ºç®€å•çš„å¥‘çº¦æ¥å…è®¸é‡ç”¨æ€§. è™½ç„¶æ¥å£ä¸æ˜¯ Go ä¸“æœ‰çš„, ä½†ç”±äº Go æ¥å£é€šå¸¸è¶‹å‘äºå°å‹åŒ–, Go ç¨‹åºå‘˜æ‰å¹¿æ³›ä½¿ç”¨å®ƒä»¬. é€šå¸¸æƒ…å†µä¸‹, ä¸€ä¸ªæ¥å£åªé™äºä¸€åˆ°ä¸¤ä¸ªæ–¹æ³•.</p>

<p>Go io åŒ…æ¥å£å°±æ˜¯å…¸å‹çš„ä¾‹å­.</p>

<h4>å……åˆ†åˆ©ç”¨é›¶å€¼ (<a href="https://www.bilibili.com/video/av18889438/?t=6m25s" >Make the zero value useful</a>)</h4>

<p>é›¶å€¼çš„å…¸å‹ä¾‹å­å¦‚ bytes.Buffer å’Œ sync.Mutex:</p>

<pre><code>var buf bytes.Buffer
buf.Write([]byte("hello"))
fmt.Println(buf.String())

var mu sync.Mutex
mu.Lock()
mu.Unlock()</code></pre>

<p>è¿™æ ·çœ‹èµ·æ¥æ˜¯ä¸æ˜¯æ„Ÿè§‰ä¸€ç‚¹ç”¨æ²¡æœ‰ ? å¦‚æœè¿™æ ·å‘¢ ?</p>

<pre><code>type Map struct {
    mu sync.RWMutex
    // ...
}

func (m *Map) Set(k, v interface{}) {
    m.mu.Lock()
    defer m.mu.Unlock()
    if m.m == nil {
        m.m = make(map[interface{}]interface{})
    }
    m.m[k] = v
}</code></pre>

<h4>interface{} è¨€ä¹‹æ— ç‰© (<a href="https://www.bilibili.com/video/av18889438/?t=7m36s" >interface{} says nothing</a>)</h4>

<p>è¯¥è°šè¯­ä¸æ˜¯è¯´ interface {} ä¸ä»£è¡¨ä»»ä½•ä¸œè¥¿, è€Œæ˜¯è¯´è¯¥ç±»å‹æ— é™æ€æ£€æŸ¥ä»¥åŠè°ƒç”¨æ—¶ä¿è¯, æ¯”å¦‚ä½ çš„ func æ¥æ”¶ä¸€ä¸ª interface{} ç±»å‹, ä½ å†™çš„æ—¶å€™æ˜¯å¯ç”¨çš„, ä½†æ˜¯æŸä¸ªæ—¶é—´ä½ è¿›è¡Œäº†ä»£ç é‡æ„å¯èƒ½åæ‰äº†.</p>

<h4>Gofmt çš„é£æ ¼æ²¡æœ‰äººå–œæ¬¢, ä½†æ˜¯ gofmt æ˜¯æ¯ä¸ªäººçš„æœ€çˆ± (<a href="https://www.bilibili.com/video/av18889438/?t=8m43s" >Gofmt's style is no one's favorite, yet gofmt is everyone's favorite</a>)</h4>

<p>è¯¥è°šè¯­å‘Šè¯‰æˆ‘ä»¬å°‘äº›é£æ ¼ä¹‹äº‰, ç”¨è¿™äº›æ—¶é—´å¤šå†™ä»£ç .</p>

<h4>å°å¤åˆ¶å¥½è¿‡å°ä¾èµ– (<a href="https://www.bilibili.com/video/av18889438/?t=9m28s" >A little copying is better than a little dependency</a>)</h4>

<p>ç®€å•è¯´å°±æ˜¯å¦‚æœä½ å¯ä»¥æ‰‹åŠ¨æ’¸å°å¿«ä»£ç å°±ä¸è¦å¯¼å…¥ä¸€ä¸ªåº“å»åš, æ¯”å¦‚ UUID:</p>

<pre><code>// see: https://groups.google.com/d/msg/golang-nuts/d0nF_k4dSx4/rPGgfXv6QCoJ
package main

import (
    "fmt"
    "os"
)

func main() {
    f, _ := os.Open("/dev/urandom") // æ¼”ç¤ºç”¨å¿½ç•¥ errcheck
    b := make([]byte, 16)
    f.Read(b)
    f.Close()
    uuid := fmt.Sprintf("%x-%x-%x-%x-%x", b[0:4], b[4:6], b[6:8], b[8:10], b[10:])
    fmt.Println(uuid)
}</code></pre>

<p>è™½ç„¶æœ‰ä¸€å †å†™å¥½çš„ UUID åº“, å½“ä½ ä»…ä»…éœ€è¦ä¸€ä¸ª UUID v4 å®ç°.</p>

<h4>ç³»ç»Ÿè°ƒç”¨å¿…é¡»å§‹ç»ˆä½¿ç”¨æ„å»ºæ ‡ç­¾ä¿è¯ (<a href="https://www.bilibili.com/video/av18889438/?t=11m10s" >Syscall must always be guarded with build tags</a>)</h4>

<p>ä¸åŒçš„ç³»ç»Ÿ (*NIX, Windows) è°ƒç”¨å¯¼è‡´ä½ åŒä¸€ä¸ª func (å®ç°å¹¶ä¸ä¸€æ ·) å¯èƒ½éœ€è¦åœ¨ä¸åŒçš„ç³»ç»Ÿä¸Šæ„å»ºæ‰èƒ½å¾—åˆ°ä½ æƒ³è¦çš„ç»“æœ. ç®€å•è¯´å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ä¸å¯ç§»æ¤æ‰è¿™ä¹ˆå¹². ç¤ºä¾‹å¯å‚è§ Go æ ‡å‡†åº“ syscall.</p>

<h4>Cgo å¿…é¡»å§‹ç»ˆä½¿ç”¨æ„å»ºæ ‡ç­¾ä¿è¯ (<a href="https://www.bilibili.com/video/av18889438/?t=11m53s" >Cgo must always be guarded with build tags</a>)</h4>

<p>åŸºæœ¬ä¸ŠåŸå› åŒä¸Šä¸€æ¡.</p>

<h4>Cgo ä¸æ˜¯ Go (<a href="https://www.bilibili.com/video/av18889438/?t=12m37s" >Cgo is not Go</a>)</h4>

<p>å¦‚æœå¯èƒ½ä¸è¦ç”¨ Cgo. è¿™é‡Œæœ‰ç¯‡<a href="https://dave.cheney.net/2016/01/18/cgo-is-not-go" >æ–‡ç« </a>è¯´æ˜äº†ä¸ºä»€ä¹ˆ.</p>

<h4>unsafe åŒ…æ— ä¿è¯ (With the unsafe package there are no guarantees)</h4>

<p>åŒ…å¦‚å…¶å, ä¸å®‰å…¨. ä½ å¯ä»¥ä½¿ç”¨ unsafe åŒ…å¦‚æœä½ å‡†å¤‡å¥½äº†æœ‰ä¸€å¤©å®ƒä¼šåæ‰.</p>

<h4>æ¸…æ™°å¥½è¿‡èªæ˜ (<a href="https://www.bilibili.com/video/av18889438/?t=14m35s" >Clear is better than clever</a>)</h4>

<p>Rob Pike åœ¨ä»–ä¸åˆ«äººåˆè‘—çš„ &lt;<a href="https://item.jd.com/11836053.html" >ç¨‹åºè®¾è®¡å®è·µ</a>&gt; ä¸­å†™åˆ°: &quot;å†™æ¸…æ™°çš„ä»£ç , ä¸è¦å†™èªæ˜çš„ä»£ç &quot;.</p>

<h4>åå°„æ°¸è¿œä¸æ˜¯æ¸…æ™°çš„ (<a href="https://www.bilibili.com/video/av18889438/?t=15m22s" >Reflection is never clear</a>)</h4>

<p>å¾ˆå¤šäººåœ¨ Stackoverflow ä¸ŠæŠ±æ€¨ Go çš„åå°„ä¸å·¥ä½œ, å› ä¸ºé‚£ä¸æ˜¯ä¸ºä½ å‡†å¤‡çš„ğŸ˜‚! åªæœ‰å¾ˆå°‘å¾ˆå°‘çš„äººåº”è¯¥ç”¨åå°„è¿™ä¸ªéå¸¸å¼ºå¤§è€Œåˆéå¸¸éš¾çš„ç‰¹æ€§. æ–°æ‰‹åº”è¯¥è¿œç¦»åå°„å’Œ interface{}.</p>

<h4>é”™è¯¯ä¹Ÿæ˜¯ä¸€ç§å€¼ (<a href="https://www.bilibili.com/video/av18889438/?t=16m13s" >Errors are values</a>)</h4>

<p>å€¼å¯ä»¥è¢«ç¼–ç¨‹, å¹¶ä¸”ç”±äºé”™è¯¯æ˜¯å€¼, æ‰€ä»¥é”™è¯¯å¯ä»¥è¢«ç¼–ç¨‹. Go å®˜æ–¹åšå®¢æœ‰å¯¹æ­¤çš„<a href="https://blog.golang.org/errors-are-values" >è§£è¯»</a>.</p>

<h4>ä¸è¦æ­¢æ­¥äºæ£€æŸ¥é”™è¯¯è€Œè¦ä¼˜é›…çš„å¤„ç† (<a href="https://www.bilibili.com/video/av18889438/?t=17m25s" >Don't just check errors, handle them gracefully</a>)</h4>

<p>Dave Cheney æœ‰ç¯‡<a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" >åšå®¢</a>è¯¦ç»†è§£è¯»äº†è¯¥è°šè¯­.</p>

<h4>è®¾è®¡æ¶æ„, å‘½åç»„ä»¶, è®°å½•ç»†èŠ‚ (<a href="https://www.bilibili.com/video/av18889438/?t=18m09s" >Design the architecture, name the components, document the details</a>)</h4>

<p>å½“ä½ å†™ä¸€ä¸ªå¤§å‹ç³»ç»Ÿçš„æ—¶å€™, ä½ æŠŠå®ƒè®¾è®¡æˆä¸€ç§ç»“æ„åŒ–çš„ä¸œè¥¿. æƒ³è±¡ç»„ä»¶çš„æ¯ä¸€ä¸ªéƒ¨åˆ†å¹¶è¡Œå·¥ä½œ, ä¸ºä¸åŒçš„ç»„ä»¶èµ·å¥½çš„åå­—, å› ä¸ºè¿™äº›åå­—ä¼šå‡ºç°åœ¨ç¨¿çº¸ä¸Š.</p>

<p>æ‹¿ Go ç¨‹åºæ¥è¯´, å¦‚æœåå­—ä¸é”™, ç»„ä»¶å°±å¥½ç†è§£, é‚£ä¹ˆç¨‹åºçš„ç»“æ„è®¾è®¡å°±ä¼šæ¸…æ™°, ç¨‹åºä¼šæ„Ÿè§‰å¾ˆè‡ªç„¶.</p>

<p>ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šä¸œè¥¿ä½ éœ€è¦è§£é‡Š, æ‰€ä»¥è¿™äº›æ˜¯ä½ éœ€è¦è§£é‡Šçš„ç»†èŠ‚. ä½†æ˜¯å‘½åä¼šå¸®åŠ©ä½ è§£é‡Šå¾ˆå¤§ä¸€éƒ¨åˆ†è®¾è®¡. ç»†èŠ‚åªæ˜¯å¡«è¡¥ææ–™çš„ç¼ºå£å¯èƒ½ç”¨æ¥ä¸ºç”¨æˆ·æ‰“å°å·¥ç¨‹å›¾è§£æ–‡æ¡£.</p>

<h4>æ–‡æ¡£æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ (<a href="https://www.bilibili.com/video/av18889438/?t=19m07s" >Documentation is for users</a>)</h4>

<p>å¾ˆå¤šäººå†™æ–‡æ¡£è¡¨æ˜æŸä¸ª func æ˜¯åšä»€ä¹ˆçš„, ä½†æ˜¯ä»–ä»¬ä¸æƒ³æƒ³è¿™ä¸ª func æ˜¯ä¸ºè°è€Œå†™. è¿™æœ‰å¾ˆå¤§çš„ä¸åŒ. ä½ çŸ¥é“è¿™ä¸ª func è¿”å›ä»€ä¹ˆæ˜¯å¯¹çš„, ä½†æ˜¯å®ƒä¸ºä»€ä¹ˆè¿”å›äº†ä½ ä½¿ç”¨çš„æ—¶å€™ä¸ä¸€æ ·çš„ç»“æœ?</p>

<p>æŠŠè‡ªå·±å½“æˆä½¿ç”¨è€…è€Œä¸æ˜¯å†™å®ƒçš„äºº, é‚£ä¹ˆ godoc ä¸Šçš„æ–‡æ¡£å°±æ˜¯å¯¹ç”¨æˆ·æœ‰ç”¨çš„. è¿™å¯¹äºå…¶ä»–è¯­è¨€ä¸€æ ·é€‚ç”¨.</p>

<h4>ä¸è¦æ…Œ (<a href="https://github.com/golang/go/wiki/CodeReviewComments#dont-panic" >Don't panic</a>)</h4>

<p>ä¸è¦ä½¿ç”¨ panic è¿›è¡Œæ­£å¸¸çš„é”™è¯¯å¤„ç†. ä½¿ç”¨é”™è¯¯ (error) å’Œå¤šä¸ªè¿”å›å€¼.</p>
 ]]></description> </item><item> <title>Go è°ƒåº¦å·¥ä½œæœºåˆ¶</title> <link>https://lingchao.xin/post/how-does-the-golang-scheduler-work.html</link> <pubDate>2018-01-27 13:25:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/how-does-the-golang-scheduler-work.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p>æœ¬æ–‡æ˜¯æ¥è‡ª Quora ä¸Šé¢ä¸€ä¸ª Go ç›¸å…³çš„<a href="https://www.quora.com/How-does-the-golang-scheduler-work/answer/Ian-Lance-Taylor?share=508736a1&srid=imO0" >é—®é¢˜</a>.
<!--more--></p>

<p>ä¸‹é¢æ˜¯ Ian Lance Taylor (Go æ ¸å¿ƒå¼€å‘è€…å…¼èµ„æ·±å…ƒè€) ç»™å‡ºçš„ç­”æ¡ˆ:</p>

<blockquote>
<p>æˆ‘å°†ç»™å‡ºä» Go 1.7 å¼€å§‹ä½¿ç”¨çš„è°ƒåº¦å™¨çš„æ¦‚è¿°.</p>

<p>è°ƒåº¦å™¨æœ‰ä¸‰ä¸ªåŸºæœ¬ç»“æ„, ç§°ä¸º G, M å’Œ P. ä¸€ä¸ª G æ˜¯ä¸€ä¸ª goroutine, ä¸€ä¸ª M æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹, ä¸€ä¸ª P æ˜¯ä¸€ä¸ª(é€»è¾‘)å¤„ç†å™¨.</p>

<p>è°ƒåº¦å™¨æœ‰ç¡®åˆ‡çš„ GOMAXPROCS æ•°é‡çš„ P (GOMAXPROCSæ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡å’Œè¿è¡Œæ—¶å‡½æ•°, ç”¨æ¥è®¾ç½®ç¨‹åºä¸­çš„å¹¶å‘åº¦).
ä¸ºäº†è®© M æ‰§è¡Œä¸€ä¸ª G, å®ƒå¿…é¡»è·å¾—ä¸€ä¸ªP, ç„¶åè¿è¡Œ G ç›´åˆ°åœæ­¢. G é€šè¿‡è¿›è¡Œè¯¸å¦‚ I/O æ“ä½œçš„ç³»ç»Ÿè°ƒç”¨, é˜»å¡ä¸€ä¸ª channel æ“ä½œ, è°ƒç”¨ C å‡½æ•°, æ­£åœ¨è¢«é¢„æŠ¢å (pre-emption)æˆ–å…¶ä»–ä¸€äº›å°çš„æƒ…å†µæ¥åœæ­¢.
ä¸€ä¸ª G åªèƒ½åœ¨ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹è¢«é¢„æŠ¢å , åœ¨å½“å‰çš„å®ç°ä¸­åªèƒ½åœ¨ä»£ç å‘ç”Ÿå‡½æ•°è°ƒç”¨çš„æ—¶å€™å‘ç”Ÿ.</p>

<p>å½“ä¸€ä¸ª G è¢«ç±»ä¼¼äºä¸€ä¸ª channel æ“ä½œé‚£æ ·é˜»å¡æ—¶, å®ƒå°†è¢«æ”¾ç½®åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­, M å°†å¯»æ‰¾å¦ä¸€ä¸ªå¯è¿è¡Œçš„ G . å¦‚æœæ²¡æœ‰å¯è¿è¡Œçš„ G, åˆ™ M å°†é‡Šæ”¾ P å¹¶è¿›å…¥ç¡çœ çŠ¶æ€.</p>

<p>å½“ G å®Œæˆç³»ç»Ÿè°ƒç”¨æ—¶, å¿…é¡»é‡æ–°è·å– P. å¦‚æœæ²¡æœ‰ P å¯ç”¨, å®ƒå°†è¢«æ ‡è®°ä¸ºå¯è¿è¡Œ, M å°†è¿›å…¥ç¡çœ çŠ¶æ€.</p>

<p>å½“ channel æ“ä½œæˆåŠŸæ—¶, å®ƒä¼šå”¤é†’å¦ä¸€ä¸ª goroutine, å°†å…¶æ ‡è®°ä¸ºå¯è¿è¡Œ, å¹¶ä¸”å¦‚æœæœ‰å¯ç”¨çš„ P, åˆ™å”¤é†’ M æ¥è¿è¡Œå®ƒ.</p>

<p>è™½ç„¶åƒåœ¾æ”¶é›†å™¨å¤§å¤šæ˜¯å¹¶å‘çš„, ä½†æœ‰å‡ ç‚¹è¦æš‚æ—¶åœæ­¢æ‰€æœ‰çš„çº¿ç¨‹æ‰èƒ½å®‰å…¨åœ°è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªæ”¶é›†é˜¶æ®µ. å®ƒé€šè¿‡æ ‡è®°æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ goroutine æ¥é¢„æŠ¢å .
å½“ä»–ä»¬åˆ°è¾¾å®‰å…¨ç‚¹æ—¶, G å’Œ M å°†è¿›å…¥ç¡çœ . å½“åƒåœ¾æ”¶é›†å™¨æ˜¯å”¯ä¸€å‰©ä¸‹çš„æ­£åœ¨è¿è¡Œçš„ G æ—¶, å®ƒå°†ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ, ç„¶åå”¤é†’ GOMAXPROC æ•°é‡çš„ M, å®ƒä»¬å°†å„è‡ªæ‰¾åˆ°å¯è¿è¡Œçš„ G, å¹¶ç»§ç»­ä¸‹å».</p>

<p>runtime.Gosched å‡½æ•°ä¿ƒä½¿ M å°†å½“å‰çš„ G æ”¾åœ¨å¯è¿è¡Œçš„ goroutine åˆ—è¡¨ä¸­, å¹¶ä»è¯¥åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæ–°çš„ G å¼€å§‹è¿è¡Œ.</p>
</blockquote>

<p>æˆ‘è®¤ä¸ºè¿™æ˜¯æ‰€æœ‰è¦ç‚¹.</p>
 ]]></description> </item><item> <title>MySQL ä¸­ Order By æŒ‰ç‰¹å®šçš„å­—æ®µå€¼æ’åº</title> <link>https://lingchao.xin/post/ordering-by-specific-field-values-with-mysql.html</link> <pubDate>2018-01-25 11:55:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/ordering-by-specific-field-values-with-mysql.html</guid> <category><![CDATA[ mysql ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª(<a href="https://www.electrictoolbox.com/mysql-order-specific-field-values/" >Ordering by specific field values with MySQL</a>)ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰</p>

<p>åœ¨ SQL æŸ¥è¯¢ä¸­å¯èƒ½æœ‰æ—¶éœ€è¦ä½¿ç”¨ ASC æˆ– DESC æˆ–ä½¿ç”¨ç‰¹æ®Šæ’åºå­—æ®µæ‰èƒ½å®Œæˆçš„ç‰¹å®šé¡ºåº. MySQL æœ‰ä¸€ä¸ª ORDER BY FIELD å‡½æ•°å¯ä»¥ç”¨æ¥åšè¿™ä¸ª.
<!--more--></p>

<h3>æµ‹è¯•æ•°æ®</h3>

<p>æœ¬æ–‡ä¸­çš„ç¤ºä¾‹æ•°æ®ä½¿ç”¨æˆ‘çš„ç¤ºä¾‹ <a href="https://www.electrictoolbox.com/mysql-example-table/" >fruit</a> è¡¨. è¿™æ˜¯ä¸€ä¸ªæœ‰ç‚¹ç®€å•çš„è¡¨, ä½†å®ƒå¯ä»¥ç”¨æ¥å¾ˆå¥½åœ°è¯´æ˜è¿™ç¯‡æ–‡ç« ä¸­çš„è§‚ç‚¹.</p>

<h3>æŒ‰ç‰¹å®šå­—æ®µå€¼æ’åº</h3>

<p>fruit è¡¨æœ‰ä¸€ä¸ª name å­—æ®µ, å…·æœ‰ä»¥ä¸‹ç‰¹å®šçš„å€¼: è‹¹æœ(Apple), é¦™è•‰(Banana), æ©˜å­(Orange), æ¢¨(Pear). æ¯ä¸ªç‰¹å®šçš„å€¼éƒ½æœ‰ä¸€ç³»åˆ—çš„å“ç§.</p>

<p>æ¯”æ–¹è¯´, ä¸ºäº†è®ºè¯çš„ç¼˜æ•…, æˆ‘ä»¬è¦æŒ‰é¦™è•‰, è‹¹æœ, æ¢¨, æ©˜å­ç­‰ç‰¹å®šçš„é¡ºåºæ’åˆ—æ•°æ®, ç„¶åå†æŒ‰å“ç§æ’åº.
ä½¿ç”¨æ™®é€šçš„ ORDER BY å­å¥ä¸å¯èƒ½è¿™æ ·åš, å› ä¸ºè¿™ä¸ªå­—æ®µçš„å‡åºæˆ–é™åºæ’åºä¸èµ·ä½œç”¨. æˆ‘ä»¬è¦ä¹ˆéœ€è¦æŸç§å½¢å¼çš„æ’åºåˆ—æˆ–è¿›è¡Œå…¶ä»–é€‰æ‹©.</p>

<p>åœ¨ ORDER BY å­å¥ä¸­ä½¿ç”¨ FIELD å‡½æ•°å¯ä»¥å®ç°è¿™ä¸€ç‚¹. å®ƒçš„å·¥ä½œæ–¹å¼æ˜¯æŒ‡å®šè¦æ’åºçš„åˆ—, ç„¶åæŒ‰é¡ºåºæ’åºå®ƒä»¬çš„å€¼. ä¾‹å¦‚:</p>

<pre><code>SELECT * FROM fruit
ORDER BY FIELD(name, 'Banana', 'Apple', 'Pear', 'Orange'), variety;</code></pre>

<p>æ¥è‡ªç¤ºä¾‹è¡¨çš„ç»“æœæ•°æ®å¦‚ä¸‹æ‰€ç¤º:</p>

<pre><code>+----------+--------+---------------------+
| fruit_id | name   | variety             |
+----------+--------+---------------------+
|       11 | Banana | Burro               |
|       12 | Banana | Cavendish           |
|       10 | Banana | Plantain            |
|        6 | Apple  | Cox's Orange Pippin |
|        7 | Apple  | Granny Smith        |
|        1 | Apple  | Red Delicious       |
|        8 | Pear   | Anjou               |
|        4 | Pear   | Bartlett            |
|        2 | Pear   | Comice              |
|        5 | Orange | Blood               |
|        3 | Orange | Navel               |
|        9 | Orange | Valencia            |
+----------+--------+---------------------+</code></pre>

<h3>ç–‘éš¾æ‚ç—‡</h3>

<p>ä½¿ç”¨æ­¤åŠŸèƒ½æ—¶æœ‰ä¸€ä¸ªå°å°çš„ <code>ç–‘éš¾æ‚ç—‡</code>. åˆ—ä¸­ä¸åœ¨ FIELD å‡½æ•°ä¸­çš„ä»»ä½•å€¼å°†åœ¨æŒ‡å®šçš„å€¼ä¹‹å‰æˆ–å¤šæˆ–å°‘éšæœºå‡ºç°. ä¾‹å¦‚, åªæŒ‡å®šè‹¹æœå’Œé¦™è•‰:</p>

<pre><code>SELECT * FROM fruit
ORDER BY FIELD(name, 'Banana', 'Apple') DESC, variety;</code></pre>

<p>è¿™å¯¼è‡´:</p>

<pre><code>+----------+--------+---------------------+
| fruit_id | name   | variety             |
+----------+--------+---------------------+
|        6 | Apple  | Cox's Orange Pippin |
|        7 | Apple  | Granny Smith        |
|        1 | Apple  | Red Delicious       |
|       11 | Banana | Burro               |
|       12 | Banana | Cavendish           |
|       10 | Banana | Plantain            |
|        8 | Pear   | Anjou               |
|        4 | Pear   | Bartlett            |
|        5 | Orange | Blood               |
|        2 | Pear   | Comice              |
|        3 | Orange | Navel               |
|        9 | Orange | Valencia            |
+----------+--------+---------------------+</code></pre>

<h3>è§£å†³é—®é¢˜çš„æ–¹æ³•</h3>

<p>è™½ç„¶é€šå¸¸åªæœ‰åœ¨ç¡®åˆ‡çš„åˆ—å·²çŸ¥çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨æ­¤å‡½æ•°, ä½†è§£å†³æ–¹æ³•æ˜¯é¢ å€’æŒ‡å®šå­—æ®µçš„é¡ºåºå¹¶æŒ‰é™åºå¯¹å…¶æ’åº, ç„¶ååœ¨åŒä¸€ä¸ªå­—æ®µä¸Šè¿›è¡Œç¬¬äºŒæ¬¡æ’åº.</p>

<p>ä¸‹é¢çš„ä¾‹å­, ä¸ç®¡å®ƒçœ‹èµ·æ¥å¦‚ä½•ï¼Œå®é™…ä¸ŠæŒ‰ç…§é¦™è•‰, è‹¹æœ, ç„¶åæŒ‰ç…§å‡åºæ’åˆ—:</p>

<pre><code>SELECT * FROM fruit
ORDER BY FIELD(name, 'Apple', 'Banana') DESC, name, variety;</code></pre>

<p>è¿™å¯¼è‡´:</p>

<pre><code>+----------+--------+---------------------+
| fruit_id | name   | variety             |
+----------+--------+---------------------+
|       11 | Banana | Burro               |
|       12 | Banana | Cavendish           |
|       10 | Banana | Plantain            |
|        6 | Apple  | Cox's Orange Pippin |
|        7 | Apple  | Granny Smith        |
|        1 | Apple  | Red Delicious       |
|        5 | Orange | Blood               |
|        3 | Orange | Navel               |
|        9 | Orange | Valencia            |
|        8 | Pear   | Anjou               |
|        4 | Pear   | Bartlett            |
|        2 | Pear   | Comice              |
+----------+--------+---------------------+</code></pre>

<p>å¦‚æœä¸€ç»„ç‰¹å®šçš„è¡Œéœ€è¦æ˜¾ç¤ºåœ¨ç»“æœé›†ä¸­çš„å…¶ä»–è¡Œä¹‹å‰, è¿™å¯èƒ½æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„è§£å†³æ–¹æ¡ˆ, ä½†æ˜¯å½“ä½¿ç”¨ ASC æˆ– DESC æ’åºé¡ºåºæ—¶, é€šå¸¸ä¸ä¼šå‡ºç°åœ¨ç¬¬ä¸€è¡Œ.</p>
 ]]></description> </item><item> <title>Golang å†…å¹•ç¬¬ 2 éƒ¨åˆ†: å‘½åè¿”å›å€¼çš„å¥½å¤„</title> <link>https://lingchao.xin/post/golang-internals-part-2-nice-benefits-of-named-return-values.html</link> <pubDate>2018-01-22 17:42:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/golang-internals-part-2-nice-benefits-of-named-return-values.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª(<a href="https://blog.minio.io/golang-internals-part-2-nice-benefits-of-named-return-values-1e95305c8687" >Golang å†…å¹•ç¬¬ 2 éƒ¨åˆ†: å‘½åè¿”å›å€¼çš„å¥½å¤„</a>)ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰</p>

<p>ä½ å¯èƒ½çŸ¥é“ Golang æä¾›äº†å‘½åè¿”å›å€¼çš„èƒ½åŠ›. åˆ°ç›®å‰ä¸ºæ­¢åœ¨ <a href="https://github.com/minio/minio" >minio</a> ä¸­æˆ‘ä»¬è¿˜æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½, ä½†æ˜¯è¿™å°†ä¼šæ”¹å˜, å› ä¸ºæˆ‘ä»¬å°†åœ¨è¿™ä¸ªåšå®¢æ–‡ç« ä¸­è§£é‡Šä¸€äº›éšè—çš„å¥½å¤„.
<!--more--></p>

<p>å¦‚æœä½ åƒæˆ‘ä»¬ä¸€æ ·, ä½ å¯èƒ½ä¼šæœ‰ç›¸å½“æ•°é‡çš„ä»£ç , å¦‚ä¸‹æ‰€ç¤º, å¯¹äºæ¯ä¸€ä¸ª return è¯­å¥ä½ éƒ½å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„å¯¹è±¡, ä»¥ä¾¿è¿”å›ä¸€ä¸ª'é»˜è®¤'å€¼:</p>

<pre><code>type objectInfo struct {
    arg1 int64
    arg2 uint64
    arg3 string
    arg4 []int
}
func NoNamedReturnParams(i int) (objectInfo) {

    if i == 1 {
        // Do one thing
        return objectInfo{}
    }

    if i == 2 {
        // Do another thing
        return objectInfo{}
    }

    if i == 3 {
        // Do one more thing still
        return objectInfo{}
    }

    // Normal return
    return objectInfo{}
}</code></pre>

<p>å¦‚æœä½ çœ‹ä¸€ä¸‹ Golang ç¼–è¯‘å™¨ç”Ÿæˆçš„å®é™…ä»£ç , ä½ å°†ä¼šå¾—åˆ°å¦‚ä¸‹çš„ç»“æœ:</p>

<pre><code>"".NoNamedReturnParams t=1 size=243 args=0x40 locals=0x0
0x0000  TEXT    "".NoNamedReturnParams(SB), $0-64
0x0000  MOVQ    $0, "".~r1+16(FP)
0x0009  LEAQ    "".~r1+24(FP), DI
0x000e  XORPS   X0, X0
0x0011  ADDQ    $-16, DI
0x0015  DUFFZERO    $288
0x0028  MOVQ    "".i+8(FP), AX
0x002d  CMPQ    AX, $1
0x0031  JEQ $0, 199
0x0037  CMPQ    AX, $2
0x003b  JEQ $0, 155
0x003d  CMPQ    AX, $3
0x0041  JNE 111
0x0043  MOVQ    "".statictmp_2(SB), AX
0x004a  MOVQ    AX, "".~r1+16(FP)
0x004f  LEAQ    "".~r1+24(FP), DI
0x0054  LEAQ    "".statictmp_2+8(SB), SI
0x005b  DUFFCOPY    $854
0x006e  RET
0x006f  MOVQ    "".statictmp_3(SB), AX
0x0076  MOVQ    AX, "".~r1+16(FP)
0x007b  LEAQ    "".~r1+24(FP), DI
0x0080  LEAQ    "".statictmp_3+8(SB), SI
0x0087  DUFFCOPY    $854
0x009a  RET
0x009b  MOVQ    "".statictmp_1(SB), AX
0x00a2  MOVQ    AX, "".~r1+16(FP)
0x00a7  LEAQ    "".~r1+24(FP), DI
0x00ac  LEAQ    "".statictmp_1+8(SB), SI
0x00b3  DUFFCOPY    $854
0x00c6  RET
0x00c7  MOVQ    "".statictmp_0(SB), AX
0x00ce  MOVQ    AX, "".~r1+16(FP)
0x00d3  LEAQ    "".~r1+24(FP), DI
0x00d8  LEAQ    "".statictmp_0+8(SB), SI
0x00df  DUFFCOPY    $854
0x00f2  RET</code></pre>

<p>ä¸€åˆ‡éƒ½å¾ˆå¥½, ä½†è¿™çœ‹èµ·æ¥æ˜¯å¦æœ‰ç‚¹é‡å¤? ä½ æ˜¯å¯¹çš„. å®è´¨ä¸Š, å¯¹äºæ¯ä¸ª return è¯­å¥, è¦è¿”å›çš„å¯¹è±¡æˆ–å¤šæˆ–å°‘è¢«åˆ†é…/åˆå§‹åŒ–(æˆ–è€…é€šè¿‡ DUFFCOPY å®æ›´ç²¾ç¡®åœ°å¤åˆ¶).</p>

<p>æ¯•ç«Ÿè¿™æ˜¯æˆ‘ä»¬é€šè¿‡åœ¨æ¯ç§æƒ…å†µä¸‹éƒ½è¿”å› objectInfo {} çš„ç»“æœ.</p>

<h3>å‘½åè¿”å›å€¼</h3>

<p>ç°åœ¨çœ‹çœ‹å¦‚æœæˆ‘ä»¬åšä¸€ä¸ªéå¸¸ç®€å•çš„æ”¹å˜ä¼šå‘ç”Ÿä»€ä¹ˆ, æœ¬è´¨ä¸Šåªæ˜¯ç»™è¿”å›å€¼ä¸€ä¸ªåå­— (oi) å’Œä½¿ç”¨ Golang çš„'è£¸ä½“'è¿”å›ç‰¹æ€§(ä¸ºè¿”å›è¯­å¥æ”¾å¼ƒå‚æ•°, è™½ç„¶è¿™ä¸æ˜¯ä¸¥æ ¼è¦æ±‚, ç¨åæ›´å¤š):</p>

<pre><code>func NamedReturnParams(i int) (oi objectInfo) {

    if i == 1 {
        // Do one thing
        return
    }

    if i == 2 {
        // Do another thing
        return
    }

    if i == 3 {
        // Do one more thing still
        return
    }

    // Normal return
    return
}</code></pre>

<p>å†çœ‹çœ‹ç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç , æˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹ç»“æœ:</p>

<pre><code>"".NamedReturnParams t=1 size=67 args=0x40 locals=0x0
    0x0000  TEXT    "".NamedReturnParams(SB), $0-64
    0x0000  MOVQ    $0, "".oi+16(FP)
    0x0009  LEAQ    "".oi+24(FP), DI
    0x000e  XORPS   X0, X0
    0x0011  ADDQ    $-16, DI
    0x0015  DUFFZERO    $288
    0x0028  MOVQ    "".i+8(FP), AX
    0x002d  CMPQ    AX, $1
    0x0031  JEQ $0, 66
    0x0033  CMPQ    AX, $2
    0x0037  JEQ $0, 65
    0x0039  CMPQ    AX, $3
    0x003d  JNE 64
    0x003f  RET
    0x0040  RET
    0x0041  RET
    0x0042  RET</code></pre>

<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å·®å¼‚, æ‰€æœ‰å››ä¸ªå¯¹è±¡åˆå§‹åŒ–å’Œ DUFFCOPY è¿™äº›ä¸œè¥¿æ¶ˆå¤±(ç”šè‡³å¯¹äºè¿™ä¸ªå¾®ä¸è¶³é“çš„æƒ…å†µ)äº†. å®ƒå°†å‡½æ•°çš„å¤§å°ä» 243 å‡å°åˆ° 67 å­—èŠ‚. å¦å¤–ä½œä¸ºä¸€ä¸ªé¢å¤–çš„å¥½å¤„, ä½ å°†çœå»ä¸€äº› CPU å‘¨æœŸé€€å‡º, å› ä¸ºä¸éœ€è¦åšä»»ä½•äº‹æƒ…æ¥è®¾ç½®è¿”å›å€¼.</p>

<p>è¯·æ³¨æ„, å¦‚æœæ‚¨ä¸å–œæ¬¢æˆ–åå¥½ Golang æä¾›çš„è£¸è¿”å›, åˆ™å¯ä»¥ä½¿ç”¨ return oi, åŒæ—¶è¿˜å¯ä»¥è·å¾—ç›¸åŒçš„å¥½å¤„, å¦‚ä¸‹æ‰€ç¤º:</p>

<pre><code>if i == 1 {
    return oi
}</code></pre>

<h3>minio æœåŠ¡å™¨ä¸­çœŸå®ä¸–ç•Œçš„ä¾‹å­</h3>

<p>æˆ‘ä»¬æ‹¿ minio server çš„ä¾‹å­æ›´è¿›ä¸€æ­¥:</p>

<pre><code>// parse credentialHeader string into its structured form.
func parseCredentialHeader(credElement string) (credentialHeader) {
    creds := strings.Split(strings.TrimSpace(credElement), "=")
    if len(creds) != 2 {
    return credentialHeader{}
    }
    if creds[0] != "Credential" {
    return credentialHeader{}
    }
    credElements := strings.Split(strings.TrimSpace(creds[1]), "/")
    if len(credElements) != 5 {
    return credentialHeader{}
    }
    if false /*!isAccessKeyValid(credElements[0])*/ {
    return credentialHeader{}
    }
    // Save access key id.
    cred := credentialHeader{
    accessKey: credElements[0],
    }
    var e error
    cred.scope.date, e = time.Parse(yyyymmdd, credElements[1])
    if e != nil {
    return credentialHeader{}
    }
    cred.scope.region = credElements[2]
    if credElements[3] != "s3" {
    return credentialHeader{}
    }
    cred.scope.service = credElements[3]
    if credElements[4] != "aws4_request" {
    return credentialHeader{}
    }
    cred.scope.request = credElements[4]
    return cred
}</code></pre>

<p>æ·±å…¥æ±‡ç¼–æˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹çš„å‡½æ•°å¤´:</p>

<pre><code>"".parseCredentialHeader t=1 size=1157 args=0x68 locals=0xb8</code></pre>

<p>å¦‚æœæˆ‘ä»¬ä¿®æ”¹ä»£ç æ¥ä½¿ç”¨ä¸€ä¸ªå‘½åè¿”å›å‚æ•°(ä¸‹é¢çš„ç¬¬äºŒä¸ªæºä»£ç å—), è¯·æ£€æŸ¥å‡½æ•°çš„å¤§å°:</p>

<pre><code>"".parseCredentialHeader t=1 size=863 args=0x68 locals=0xb8 </code></pre>

<p>å®ƒä»æ€»å…± 1150 ä¸ªå­—èŠ‚ä¸­åˆ é™¤äº† 300 ä¸ªå­—èŠ‚, è¿™å¯¹äºæºä»£ç è¿™æ ·ä¸€ä¸ªæœ€å°çš„æ”¹å˜è¿˜ä¸é”™. å–å†³äºä½ ä»å“ªé‡Œæ¥ï¼Œä½ ä¹Ÿå¯èƒ½æ›´å–œæ¬¢æºä»£ç çš„æ›´å¹²å‡€çš„å¤–è§‚:</p>

<pre><code>// parse credentialHeader string into its structured form.
func parseCredentialHeader(credElement string) (ch credentialHeader) {
    creds := strings.Split(strings.TrimSpace(credElement), "=")
    if len(creds) != 2 {
    return
    }
    if creds[0] != "Credential" {
    return
    }
    credElements := strings.Split(strings.TrimSpace(creds[1]), "/")
    if len(credElements) != 5 {
    return
    }
    if false /*!isAccessKeyValid(credElements[0])*/ {
    return
    }
    // Save access key id.
    cred := credentialHeader{
    accessKey: credElements[0],
    }
    var e error
    cred.scope.date, e = time.Parse(yyyymmdd, credElements[1])
    if e != nil {
    return
    }
    cred.scope.region = credElements[2]
    if credElements[3] != "s3" {
    return
    }
    cred.scope.service = credElements[3]
    if credElements[4] != "aws4_request" {
    return
    }
    cred.scope.request = credElements[4]
    return cred
}</code></pre>

<p>è¯·æ³¨æ„, å®é™…ä¸Š ch å˜é‡æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å±€éƒ¨å˜é‡, å°±åƒåœ¨å‡½æ•°ä¸­å®šä¹‰çš„ä»»ä½•å…¶ä»–å±€éƒ¨å˜é‡ä¸€æ ·. å› æ­¤, æ‚¨å¯ä»¥å°†å…¶å€¼ä»é»˜è®¤çš„'é›¶'çŠ¶æ€æ›´æ”¹(å½“ç„¶, ä¿®æ”¹åçš„ç‰ˆæœ¬å°†åœ¨é€€å‡ºæ—¶è¿”å›).</p>

<h3>å‘½åè¿”å›å€¼çš„å…¶ä»–ç”¨æ³•</h3>

<p>æ­£å¦‚å‡ ä½äººå£«æŒ‡å‡ºçš„é‚£æ ·, æŒ‡å®šè¿”å›å€¼çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥åœ¨é—­åŒ…ä¸­ä½¿ç”¨(å³ defer è¯­å¥). å› æ­¤, å¯ä»¥åœ¨ä½œä¸º defer è¯­å¥çš„ç»“æœè°ƒç”¨çš„å‡½æ•°ä¸­è®¿é—®æŒ‡å®šçš„è¿”å›å€¼, å¹¶ç›¸åº”åœ°è¿›è¡Œæ“ä½œ.</p>

<h3>å…³äºè¿™ä¸ªç³»åˆ—</h3>

<p>å¦‚æœä½ é”™è¿‡äº†æœ¬ç³»åˆ—çš„ç¬¬ä¸€éƒ¨åˆ†, è¿™é‡Œæ˜¯ä¸€ä¸ªé“¾æ¥:</p>

<ul>
<li>å…³äº <a href="https://blog.minio.io/golang-internals-part-1-autogenerated-functions-and-how-to-get-rid-of-them-6ca4749cc236" >autogenerated</a> å‡½æ•°</li>
</ul>

<h3>ç»“è®º</h3>

<p>æ‰€ä»¥æˆ‘ä»¬å°†é€æ¸é‡‡ç”¨å‘½åçš„è¿”å›å€¼, æ— è®ºæ˜¯æ–°ä»£ç è¿˜æ˜¯ç°æœ‰ä»£ç .</p>

<p>äº‹å®ä¸Š, æˆ‘ä»¬ä¹Ÿåœ¨ç ”ç©¶æ˜¯å¦å¯ä»¥å¼€å‘ä¸€äº›å°å·¥å…·æ¥å¸®åŠ©æˆ–è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹. æŒ‰ç…§ gofmt çš„æ€è·¯æ€è€ƒ, ç„¶åè‡ªåŠ¨ä¿®æ”¹æºä»£ç ä»¥è¿›è¡Œä¸Šé¢æ‰€è¿°çš„æ›´æ”¹.
ç‰¹åˆ«æ˜¯åœ¨è¿”å›å€¼è¿˜æ²¡æœ‰è¢«å‘½åçš„æƒ…å†µä¸‹(å› æ­¤å®ç”¨ç¨‹åºå¿…é¡»ç»™å®ƒä¸€ä¸ªåå­—), è¿™ä¸ªè¿”å›å˜é‡åœ¨ç°æœ‰çš„æºä»£ç ä¸­ä»¥ä»»ä½•æ–¹å¼æ”¹å˜éƒ½æ˜¯ä¸å¯èƒ½çš„, ch (åœ¨ä¸Šé¢åˆ—è¡¨çš„æƒ…å†µä¸‹)ä¸ä¼šå¯¼è‡´ç¨‹åºçš„ä»»ä½•åŠŸèƒ½å˜åŒ–.</p>

<p>æ‰€ä»¥è¯·ç»§ç»­å…³æ³¨.</p>

<p>æˆ‘ä»¬å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©, å¹¶æä¾›ä¸€äº›å…³äº Go å¦‚ä½•åœ¨å†…éƒ¨è¿è¡Œä»¥åŠå¦‚ä½•æ”¹è¿› Golang ä»£ç çš„æ–°è§è§£.</p>

<h3>æ›´æ–°</h3>

<p>å·²ç»æœ‰ä¸€ä¸ª Golang <a href="https://github.com/golang/go/issues/20859" >issue</a> æ¥ä¼˜åŒ–ç¼–è¯‘å™¨ä¸ºä¸Šè¿°æƒ…å†µç”Ÿæˆç›¸åŒçš„ä»£ç , è¿™å°†æ˜¯ä¸€ä»¶å¥½äº‹.</p>
 ]]></description> </item><item> <title>Go æ²¡æœ‰ä¼ å¼•ç”¨</title> <link>https://lingchao.xin/post/there-is-no-pass-by-reference-in-go.html</link> <pubDate>2018-01-15 16:05:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/there-is-no-pass-by-reference-in-go.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª(<a href="https://dave.cheney.net/2017/04/29/there-is-no-pass-by-reference-in-go" >Go æ²¡æœ‰ä¼ å¼•ç”¨</a>)ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰.
<!--more--></p>

<p>è¦æ¸…æ¥šçš„æ˜¯, Go æ²¡æœ‰å¼•ç”¨å˜é‡, æ‰€ä»¥ Go æ²¡æœ‰ä¼ é€’å¼•ç”¨å‡½æ•°çš„è°ƒç”¨è¯­ä¹‰.</p>

<h3>ä»€ä¹ˆæ˜¯å¼•ç”¨å˜é‡(reference variable) ?</h3>

<p>åœ¨åƒ C++ è¿™æ ·çš„è¯­è¨€ä¸­, ä½ å¯ä»¥å£°æ˜ä¸€ä¸ªåˆ«å, æˆ–è€…ä¸€ä¸ªç°æœ‰å˜é‡çš„æ›¿ä»£åç§°. è¿™è¢«ç§°ä¸ºå¼•ç”¨å˜é‡.</p>

<pre><code><span class="code"><span class="special">#include &lt;stdio.h&gt;
</span>
<span class="symbol">int</span> main<span class="paren1">(<span class="code"></span>)</span> <span class="paren1">{<span class="code">
        <span class="symbol">int</span> a = 10;
        <span class="symbol">int</span> &amp;b = a;
        <span class="symbol">int</span> &amp;c = b;

        printf<span class="paren2">(<span class="code"><span class="string">"%p %p %p</span><span class="string">\n</span><span class="string">"</span>, &amp;a, &amp;b, &amp;c</span>)</span>; <span class="comment">// 0x7ffe114f0b14 0x7ffe114f0b14 0x7ffe114f0b14
</span>        <span class="symbol">return</span> 0;
</span>}</span></span></code></pre>

<p>ä½ å¯ä»¥çœ‹åˆ° a, b å’Œ c éƒ½æŒ‡å‘ç›¸åŒçš„å†…å­˜ä½ç½®. å†™å…¥ a ä¼šæ”¹å˜ b å’Œ c çš„å†…å®¹. å½“ä½ æƒ³åœ¨å‡½æ•°è°ƒç”¨ä¸åŒçš„ä½œç”¨åŸŸå£°æ˜å¼•ç”¨å˜é‡æ—¶, è¿™æ˜¯å¾ˆæœ‰ç”¨çš„.</p>

<h3>Go æ²¡æœ‰å¼•ç”¨å˜é‡</h3>

<p>ä¸ C++ ä¸åŒ, Go ç¨‹åºä¸­å®šä¹‰çš„æ¯ä¸ªå˜é‡éƒ½å ç”¨ä¸€ä¸ªå”¯ä¸€çš„å†…å­˜ä½ç½®.</p>

<pre><code>package main

import "fmt"

func main() {
        var a, b, c int
        fmt.Println(&a, &b, &c) // 0x1040a124 0x1040a128 0x1040a12c
}</code></pre>

<p>åˆ›å»ºä¸€ä¸ªä¸¤ä¸ªå˜é‡åœ¨å†…å­˜ä¸­å…±äº«ç›¸åŒçš„å­˜å‚¨ä½ç½®çš„ Go ç¨‹åºæ˜¯ä¸å¯èƒ½çš„. å¯ä»¥åˆ›å»ºä¸¤ä¸ªå˜é‡, å…¶å†…å®¹æŒ‡å‘ç›¸åŒçš„å­˜å‚¨ä½ç½®, ä½†ä¸å…±äº«ç›¸åŒå­˜å‚¨ä½ç½®çš„ä¸¤ä¸ªå˜é‡ä¸åŒ.</p>

<pre><code>package main

import "fmt"

func main() {
        var a int
        var b, c = &a, &a
        fmt.Println(b, c)   // 0x1040a124 0x1040a124
        fmt.Println(&b, &c) // 0x1040c108 0x1040c110
}</code></pre>

<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­, b å’Œ c ä¿æŒç›¸åŒçš„å€¼, å³ a çš„åœ°å€. ä½†æ˜¯, b å’Œ c æœ¬èº«å­˜å‚¨åœ¨ä¸åŒçš„ä½ç½®. æ›´æ–° b çš„å†…å®¹å¯¹ c æ²¡æœ‰å½±å“.</p>

<h3>ä½†æ˜¯ map å’Œ channel æ˜¯å¼•ç”¨å— ?</h3>

<p>é”™, map å’Œ channel ä¸æ˜¯å¼•ç”¨. å¦‚æœä»–ä»¬æ˜¯, é‚£ä¹ˆä¸‹é¢è¿™ä¸ªç¨‹åºå°†æ‰“å° false .</p>

<pre><code>package main

import "fmt"

func fn(m map[int]int) {
        m = make(map[int]int)
}

func main() {
        var m map[int]int
        fn(m)
        fmt.Println(m == nil)
}</code></pre>

<p>å¦‚æœmap m æ˜¯ä¸€ä¸ª C++ é£æ ¼çš„å¼•ç”¨å˜é‡, åˆ™åœ¨ main ä¸­å£°æ˜çš„ m å’Œ åœ¨ fn ä¸­å£°æ˜çš„ m å°†åœ¨å†…å­˜ä¸­å æ®ç›¸åŒçš„å­˜å‚¨ä½ç½®. ä½†æ˜¯, å› ä¸ºå¯¹ fn å†…çš„ m çš„èµ‹å€¼å¯¹ m çš„å€¼æ²¡æœ‰å½±å“, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹åˆ° m ä¸æ˜¯å¼•ç”¨å˜é‡.</p>

<h3>ç»“è®º</h3>

<p>Go æ²¡æœ‰ä¼ é€’å¼•ç”¨è¯­ä¹‰, å› ä¸º Go æ²¡æœ‰å¼•ç”¨å˜é‡.</p>
 ]]></description> </item><item> <title>ä¸ºä»€ä¹ˆ Golang åƒåœ¾å›æ”¶å™¨ä¸å®ç°åˆ†ä»£å’Œç´§å‡‘ gc</title> <link>https://lingchao.xin/post/why-golang-garbage-collector-not-implement-generational-and-compact-gc.html</link> <pubDate>2018-01-13 16:30:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/why-golang-garbage-collector-not-implement-generational-and-compact-gc.html</guid> <category><![CDATA[ go ]]></category><category><![CDATA[ gc ]]></category> <description><![CDATA[ <p>æœ¬æ–‡è¯‘è‡ª Google è®ºå›(<a href="https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ" >golang-nuts</a>)ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰.</p>

<p>æœ‰äººåœ¨è®ºå›é‡Œé¢é—®: ä¸ºä»€ä¹ˆ Golang åƒåœ¾å›æ”¶å™¨ä¸å®ç°åˆ†ä»£å’Œç´§å‡‘ gc ?
<!--more--></p>

<p>Ian Lance Taylor çš„å›å¤:</p>

<blockquote>
<p>è¿™å·²ç»åœ¨è¿‡å»è®¨è®ºè¿‡äº†.</p>

<p>å¿½ç•¥ç»†èŠ‚, ç´§å‡‘(compacting) GC çš„åŸºæœ¬ä¼˜ç‚¹æ˜¯:</p>

<ul>
<li>é¿å…ç¢ç‰‡, ä»¥åŠ;</li>
<li>å…è®¸ä½¿ç”¨ç®€å•è€Œæœ‰æ•ˆçš„å‡¹å‡¸åˆ†é…å™¨(bump allocator).</li>
</ul>

<p>ä½†æ˜¯, ç°ä»£çš„å†…å­˜åˆ†é…ç®—æ³•, è±¡ Go è¿è¡Œæ—¶ä½¿ç”¨çš„åŸºäº tcmalloc çš„æ–¹æ¡ˆåŸºæœ¬ä¸Šæ²¡æœ‰ç¢ç‰‡é—®é¢˜.
è€Œå‡¹å‡¸åˆ†é…å™¨å¯¹äº Go è¿™æ ·éœ€è¦é”çš„å¤šçº¿ç¨‹ç¨‹åºä¸­çš„å•çº¿ç¨‹ç¨‹åºæ˜¯ç®€å•æœ‰æ•ˆçš„.
ä¸€èˆ¬æ¥è¯´, è¿™å¯èƒ½æ›´å¤šæœ‰æ•ˆåœ°ä½¿ç”¨ä¸€ç»„æ¯ä¸ªçº¿ç¨‹ç¼“å­˜æ¥åˆ†é…å†…å­˜, è€Œåœ¨è¿™ä¸€ç‚¹ä¸Šä½ å·²ç»å¤±å»äº†å‡¹å‡¸åˆ†é…å™¨çš„ä¼˜åŠ¿.
æ‰€ä»¥æˆ‘ä¼šæ–­è¨€, ä¸€èˆ¬æ¥è¯´æœ‰å¾ˆå¤šæ³¨æ„äº‹é¡¹å¯¼è‡´ä»Šå¤©æ²¡æœ‰çœŸæ­£çš„ä¼˜åŠ¿ä¸ºä¸€ä¸ªå¤šçº¿ç¨‹ç¨‹åºä½¿ç”¨å‹ç¼©å†…å­˜åˆ†é…å™¨.
æˆ‘ä¸æ˜¯è¯´ä½¿ç”¨å‹ç¼©åˆ†é…å™¨æœ‰ä»€ä¹ˆé—®é¢˜, æˆ‘åªæ˜¯è®¤ä¸ºå®ƒç›¸å¯¹äºéå‹ç¼©çš„æ¥è¯´æ²¡æœ‰å¸¦æ¥ä»»ä½•å¤§çš„ä¼˜åŠ¿.</p>

<p>ç°åœ¨æˆ‘ä»¬æ¥è€ƒè™‘ä¸€ä¸‹åˆ†ä»£ GC. åˆ†ä»£ GC çš„å…³é”®ä¾èµ–äºä¸–ä»£çš„å‡è®¾: åˆ†é…åœ¨ä¸€ä¸ªç¨‹åºä¸­çš„å¤§éƒ¨åˆ†å€¼å¾ˆå¿«å˜å¾—ä¸ä¼šç”¨åˆ°, æ‰€ä»¥åˆ†ä»£ GC æœ‰ä¸€ä¸ªä¼˜åŠ¿å°±æ˜¯å¯ä»¥èŠ±æ›´å¤šçš„æ—¶é—´æŸ¥çœ‹æœ€è¿‘åˆ†é…çš„å¯¹è±¡.
è¿™é‡Œ Go ä¸åŒäºè®¸å¤šåƒåœ¾æ”¶é›†è¯­è¨€, å› ä¸ºè®¸å¤šå¯¹è±¡æ˜¯ç›´æ¥åœ¨ç¨‹åºæ ˆ(stack)ä¸Šåˆ†é…çš„. Go ç¼–è¯‘å™¨ä½¿ç”¨é€ƒé€¸åˆ†æ(escape analysis)æ¥æŸ¥æ‰¾é‚£äº›åœ¨ç¼–è¯‘æ—¶ç”Ÿå‘½å‘¨æœŸå°±å·²çŸ¥çš„å¯¹è±¡, å°†å®ƒä»¬åˆ†é…åˆ°å †æ ˆè€Œä¸æ˜¯åƒåœ¾æ”¶é›†çš„å†…å­˜ä¸­.
æ‰€ä»¥ä¸€èˆ¬æ¥è¯´, åœ¨ Go ä¸­, ä¸å…¶ä»–è¯­è¨€ç›¸æ¯”, æœ‰å¾ˆå¤§æ¯”ä¾‹çš„åˆ†ä»£ GC è¦æ‰¾çš„å¾ˆå¿«ä¸ä¼šç”¨åˆ°çš„(quickly-unused)å€¼ä¸ä¼šåˆ†é…åœ¨ GC å†…å­˜çš„é¦–è¦ä½ç½®.
æ‰€ä»¥åˆ†ä»£ GC èƒ½ç»™ Go å¸¦æ¥çš„ä¼˜åŠ¿ç›¸å¯¹äºå…¶ä»–è¯­è¨€è¦å°.</p>

<p>æ›´å¾®å¦™çš„æ˜¯, å¤§å¤šæ•°ä¸–ä»£ GC å®ç°çš„éšè—ç‚¹æ˜¯å‡å°‘åƒåœ¾æ”¶é›†å¸¦æ¥çš„ç¨‹åºæš‚åœçš„æ—¶é—´.
æš‚åœæœŸé—´åªçœ‹æœ€å¹´è½»çš„ä¸€ä»£, æš‚åœæ—¶é—´å¾ˆçŸ­. ç„¶è€Œ, Go ä½¿ç”¨äº†ä¸€ä¸ªå¹¶å‘åƒåœ¾æ”¶é›†å™¨, å¹¶ä¸”åœ¨ Go ä¸­ç¨‹åºæš‚åœæ—¶é—´ä¸å¹´è½»ä»£æˆ–è€…ä»»æ„ä»£çš„å¤§å°æ— å…³.
Go åŸºæœ¬ä¸Šå‡è®¾, åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­, é€šè¿‡åœ¨ä¸åŒçš„æ ¸ä¸Šå¹¶è¡Œè¿è¡Œ GC, ä¸æ˜¯ä¸ºäº†æœ€å°åŒ– GC æ—¶é—´å»æš‚åœå¯¼è‡´ç¨‹åºè¿è¡Œæ›´é•¿çš„æ—¶é—´, è€Œæ˜¯æ€»ä½“ä¸ŠèŠ±æ›´å¤šçš„æ€» CPU æ—¶é—´åœ¨ GC ä¸Š.</p>

<p>æ€»ä¹‹, åˆ†ä»£ GC å¯èƒ½ä»ç„¶å¯ä»¥ä¸º Go å¸¦æ¥æ˜¾è‘—çš„ä»·å€¼, å³å‡å°‘å¹¶è¡Œ GC æ—¶çš„å·¥ä½œé‡. è¿™æ˜¯ä¸€ä¸ªéœ€è¦æµ‹è¯•çš„å‡è®¾. Go å½“å‰çš„ GC å·¥ä½œå®é™…ä¸Šæ­£åœ¨å¯†åˆ‡å…³æ³¨ä¸€ä¸ªç›¸å…³ä½†ä¸åŒçš„å‡è®¾: Go ç¨‹åºå¯èƒ½å€¾å‘äºæŒ‰è¯·æ±‚åˆ†é…å†…å­˜.
<a href="https://docs.google.com/document/d/1gCsFxXamW8RRvOe5hECz98Ftk-tcRRJcDFANj2VwCB0/view" >è¿™é‡Œ</a>æœ‰ä¸€ä¸ªæè¿°. è¿™é¡¹å·¥ä½œæ­£åœ¨è¿›è¡Œä¸­, ç°å®æƒ…å†µæ˜¯å¦æœ‰åˆ©è¿˜æœ‰å¾…è§‚å¯Ÿ.</p>
</blockquote>
 ]]></description> </item><item> <title>Go Range å¾ªç¯å†…å¹•</title> <link>https://lingchao.xin/post/go-range-loop-internals.html</link> <pubDate>2018-01-10 20:20:04</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/go-range-loop-internals.html</guid> <category><![CDATA[ go ]]></category> <description><![CDATA[ <p><a href="https://garbagecollected.org/2017/02/22/go-range-loop-internals/" >è¯‘æ–‡</a>ç‰ˆæƒ@å½’åŸæ–‡æ‰€æœ‰.</p>

<p>è™½ç„¶ä»–ä»¬éå¸¸æ–¹ä¾¿, ä½†æˆ‘æ€»æ˜¯å‘ç° Go çš„ Range å¾ªç¯æœ‰ç‚¹ç¥ç§˜. æˆ‘å¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ª:
<!--more--></p>

<pre><code>// http://bit.ly/2CXC1Ob æ¥è‡ª Dave Cheney.
package main

func main() {
    v := []int{1, 2, 3}
    for i := range v {
        v = append(v, i)
    }
}</code></pre>

<p>ç°åœ¨æˆ‘å¯ä»¥æŠŠè¿™äº›äº‹å®è®°å½•ä¸‹æ¥, ä½†æ˜¯æˆ‘å¾ˆå¯èƒ½ä¼šå¿˜è®°. ä¸ºäº†æœ‰æ›´å¥½çš„æœºä¼šè®°ä½è¿™ä¸ª, æˆ‘éœ€è¦æ‰¾å‡ºä¸ºä»€ä¹ˆ range å¾ªç¯ä¼šè¿™æ ·. æ‰€ä»¥æˆ‘å†™äº†è¿™ç¯‡æ–‡ç« .</p>

<h3>Step 1: è¯»æ‰‹å†Œ(RTFM)</h3>

<p>æˆ‘ä»¬é¦–å…ˆåº”è¯¥å»è¯» range å¾ªç¯æ–‡æ¡£. Goè¯­è¨€è§„èŒƒæ–‡æ¡£åœ¨ <a href="https://golang.org/ref/spec#For_statements" >for è¯­å¥</a>éƒ¨åˆ†çš„ <em>For è¯­å¥å’Œ range å­å¥</em>æè¿°äº† range å¾ªç¯.
æˆ‘ä¸ä¼šåœ¨è¿™é‡Œå¤åˆ¶æ•´ä¸ªè§„èŒƒï¼Œæˆ‘ä¼šæ€»ç»“ä¸€äº›æœ‰è¶£çš„éƒ¨åˆ†.</p>

<p>é¦–å…ˆ, è®©æˆ‘ä»¬æé†’è‡ªå·±æˆ‘ä»¬åœ¨è¿™é‡Œçœ‹åˆ°ä»€ä¹ˆ:</p>

<pre><code>for i := range a {
    fmt.Println(i)
}</code></pre>

<h4>Range å˜é‡</h4>

<p>ä½ ä»¬ä¸­çš„å¤§å¤šæ•°äººä¼šçŸ¥é“, åœ¨ Range å­å¥çš„å·¦è¾¹(ä¸Šé¢çš„ä¾‹å­ä¸­çš„ i), ä½ å¯ä»¥è¿™æ ·åˆ†é…å¾ªç¯å˜é‡:</p>

<ul>
<li>åˆ†é… (=)</li>
<li>çŸ­å˜é‡å£°æ˜ (:=)</li>
</ul>

<p>æ‚¨ä¹Ÿå¯ä»¥é€‰æ‹©å®Œå…¨å¿½ç•¥å¾ªç¯å˜é‡.</p>

<p>å¦‚æœä½¿ç”¨çŸ­å˜é‡å£°æ˜æ ·å¼åˆ†é…(:=), åˆ™ Go å°†åœ¨å¾ªç¯çš„æ¯ä¸ªè¿­ä»£ä¸­é‡ç”¨å˜é‡(ä»…åœ¨å¾ªç¯å†…çš„èŒƒå›´å†…).</p>

<h4>Range è¡¨è¾¾å¼</h4>

<p>åœ¨ Range å­å¥çš„å³è¾¹(ä¸Šé¢çš„ä¾‹å­ä¸­çš„ a), ä½ å¯ä»¥æ‰¾åˆ°ä»–ä»¬ç§°ä¹‹ä¸º Range è¡¨è¾¾å¼çš„ä¸œè¥¿. å®ƒå¯ä»¥åŒ…å«ä»»ä½•è¡¨è¾¾å¼, å…¶è®¡ç®—ç»“æœå¦‚ä¸‹:</p>

<ul>
<li>æ•°ç»„(array)</li>
<li>æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆ</li>
<li>åˆ‡ç‰‡(slice)</li>
<li>å­—ç¬¦ä¸²(string)</li>
<li>å­—å…¸(map)</li>
<li>å…è®¸æ¥æ”¶çš„ç®¡é“(channel), å¦‚: chan int æˆ–è€… chan&lt;- int</li>
</ul>

<p><strong>Range è¡¨è¾¾å¼åœ¨å¼€å§‹å¾ªç¯ä¹‹å‰åªè®¡ç®—ä¸€æ¬¡</strong>. è¯·æ³¨æ„, è¿™ä¸ªè§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–: å¦‚æœ Range ä¸€ä¸ªæ•°ç»„(æˆ–æŒ‡å‘å®ƒçš„æŒ‡é’ˆ), ä½ åªèƒ½åˆ†é…ç´¢å¼•ï¼šé‚£ä¹ˆåªæœ‰ len(a) è¢«è®¡ç®—.
ä»…è®¡ç®— len(a) æ„å‘³ç€å¯ä»¥åœ¨ç¼–è¯‘æ—¶è®¡ç®—è¡¨è¾¾å¼ a, å¹¶ç”±ç¼–è¯‘å™¨ç”¨å¸¸é‡æ›¿æ¢. <a href="https://golang.org/ref/spec#Length_and_capacity" >len å‡½æ•°è§„èŒƒ</a>è§£é‡Šå¦‚ä¸‹:</p>

<blockquote>
<p>å¦‚æœsçš„ç±»å‹æ˜¯æ•°ç»„æˆ–æŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆå¹¶ä¸”è¡¨è¾¾å¼ s ä¸åŒ…å«é€šé“æ¥æ”¶(channel receives) æˆ–(é å¸¸é‡) å‡½æ•°è°ƒç”¨, åˆ™è¡¨è¾¾å¼ len(s) å’Œ cap(s) æ˜¯å¸¸é‡. åœ¨è¿™ç§æƒ…å†µä¸‹ s ä¸è¢«è®¡ç®—. å¦åˆ™, len å’Œ cap çš„è°ƒç”¨ä¸æ˜¯å¸¸é‡, è€Œæ˜¯è¢«è®¡ç®—.</p>
</blockquote>

<p>é‚£ä¹ˆ &quot;è®¡ç®—(evaluated)&quot; ç©¶ç«Ÿæ„å‘³ç€ä»€ä¹ˆå‘¢? ä¸å¹¸çš„æ˜¯æˆ‘ä¸èƒ½åœ¨è§„èŒƒä¸­æ‰¾åˆ°è¿™ä¸ªä¿¡æ¯. å½“ç„¶, æˆ‘å¯ä»¥çŒœæµ‹, è¿™æ„å‘³ç€å®Œå…¨æ‰§è¡Œè¡¨è¾¾å¼, ç›´åˆ°å®ƒä¸èƒ½è¿›ä¸€æ­¥å‡å°‘. åœ¨ä»»ä½•æƒ…å†µä¸‹, è¿™é‡Œçš„é«˜ä½æ˜¯ Range è¡¨è¾¾å¼åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰è®¡ç®—ä¸€æ¬¡. ä½ å¦‚ä½•åªè¯„ä¼°ä¸€ä¸ªè¡¨è¾¾å¼ä»…ä¸€æ¬¡? é€šè¿‡å°†å…¶åˆ†é…ç»™ä¸€ä¸ªå˜é‡! è¿™å¯èƒ½æ˜¯è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…å—?</p>

<p>æœ‰è¶£çš„æ˜¯, è¿™ä¸ªè§„èŒƒæåˆ°äº†ä¸€äº›å…³äºä» map ä¸­æ·»åŠ å’Œåˆ é™¤çš„ç‰¹æ®Šçš„ä¸œè¥¿(æ²¡æœ‰æåˆ°åˆ‡ç‰‡):</p>

<blockquote>
<p>å¦‚æœåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ç§»é™¤å°šæœªåˆ°è¾¾çš„ map é¡¹, åˆ™ä¸ä¼šç”Ÿæˆç›¸åº”çš„è¿­ä»£å€¼. å¦‚æœè¿­ä»£è¿‡ç¨‹ä¸­åˆ›å»º map é¡¹, é‚£ä¹ˆå¯èƒ½ä¼šåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ç”Ÿæˆè¯¥é¡¹, æˆ–è€…å¯èƒ½ä¼šè·³è¿‡è¯¥é¡¹.</p>
</blockquote>

<p>æˆ‘ç¨åä¼šå›åˆ° map.</p>

<h3>Step 2: Range æ”¯æŒçš„æ•°æ®ç±»å‹</h3>

<p>å¦‚æœæˆ‘ä»¬å‡è®¾ Range è¡¨è¾¾å¼åœ¨å¾ªç¯å¼€å§‹ä¹‹å‰è¢«èµ‹å€¼äº†ä¸€æ¬¡, é‚£ä¹ˆè¿™æ˜¯ä»€ä¹ˆæ„æ€? ç­”æ¡ˆæ˜¯å®ƒå–å†³äºæ•°æ®ç±»å‹, æ‰€ä»¥è®©æˆ‘ä»¬ä»”ç»†çœ‹ä¸€ä¸‹ Range æ‰€æ”¯æŒçš„æ•°æ®ç±»å‹.</p>

<p>åœ¨æˆ‘ä»¬è¿™æ ·åšä¹‹å‰, è¯·è®°ä½è¿™ä¸€ç‚¹: <strong>åœ¨ Go ä¸­, æ‚¨åˆ†é…çš„æ‰€æœ‰ä¸œè¥¿éƒ½è¢«å¤åˆ¶</strong>. å¦‚æœæ‚¨åˆ†é…ä¸€ä¸ªæŒ‡é’ˆ, åˆ™å¤åˆ¶æŒ‡é’ˆ.å¦‚æœä½ åˆ†é…ä¸€ä¸ªç»“æ„ä½“, åˆ™å¤åˆ¶ç»“æ„.å°†å‚æ•°ä¼ é€’ç»™å‡½æ•°æ—¶ä¹Ÿæ˜¯å¦‚æ­¤. æ— è®ºå¦‚ä½•, è¿™é‡Œæ˜¯:</p>

<p>// TODO</p>

<p>è¯·å‚é˜…æœ¬æ–‡åº•éƒ¨çš„å‚è€ƒèµ„æ–™, äº†è§£æ›´å¤šå…³äºè¿™äº›æ•°æ®ç±»å‹çš„å†…éƒ¨ç»“æ„.</p>

<p>é‚£ä¹ˆè¿™æ˜¯ä»€ä¹ˆæ„æ€? è¿™äº›ä¾‹å­çªå‡ºäº†ä¸€äº›å·®å¼‚:</p>

<pre><code>// copies the entire array
var a [10]int
acopy := a

// copies the slice header struct only, NOT the backing array
s := make([]int, 10)
scopy := s

// copies the map pointer only
m := make(map[string]int)
mcopy := m</code></pre>

<p>æ‰€ä»¥å¦‚æœåœ¨ä¸€ä¸ª Range å¾ªç¯çš„å¼€å§‹å¤„, ä½ å¯ä»¥å°†ä¸€ä¸ªæ•°ç»„è¡¨è¾¾å¼èµ‹å€¼ç»™ä¸€ä¸ªå˜é‡(ä»¥ç¡®ä¿å®ƒåªèƒ½è®¡ç®—ä¸€æ¬¡), é‚£ä¹ˆä½ å°†å¤åˆ¶æ•´ä¸ªæ•°ç»„.</p>

<h3>Step 3: Go ç¼–è¯‘å™¨æºç </h3>

<p>(æœªå®Œå¾…ç»­)</p>
 ]]></description> </item><item> <title>2017 å·²é€</title> <link>https://lingchao.xin/post/2017-has-passed.html</link> <pubDate>2017-12-31 15:26:20</pubDate> <author>Lingchao Xin</author> <guid isPermaLink="true">https://lingchao.xin/post/2017-has-passed.html</guid> <category><![CDATA[ note ]]></category> <description><![CDATA[ <h3>2017 çš„ç›®æ ‡å®ç°äº†å—</h3>

<!--more-->

<p>å…ˆå›é¡¾ä¸€ä¸‹ 2017 å¹´çš„ç›®æ ‡:</p>

<ul>
<li><p><em>Go</em> è¯­è¨€ç»§ç»­è¶æ‰‹</p></li>
<li><p><em>Kotlin</em> ä¿®ç‚¼, æå¸¦ <em>Java 8</em></p></li>
<li><p><em>Python 3.6</em> ç‰¹æ€§åŠ æŒ</p></li>
<li><p><em>OCaml</em> æŠŠç©</p></li>
</ul>

<p>é™¤äº† Go è¯­è¨€ç»§ç»­è¶æ‰‹, å…¶ä»–çš„çœŸçš„æ²¡æ‰€è°“äº†.</p>

<h3>ç°å®ä¼šç»™ä½ ä»¥æ•™è®­</h3>

<p>2017 å¹´ä¸ç®¡å¯¹äºå·¥ä½œè¿˜æ˜¯ç”Ÿæ´»çœŸçš„è®©æˆ‘æ¶¨è§è¯†äº†;</p>

<ul>
<li><p>å¥½å¥½æ´»ç€;</p></li>
<li><p>èµ°å‡ºèˆ’é€‚åŒº;</p></li>
<li><p>é‡å¿ƒéœ€è¦æŠ€èƒ½åŒ¹é…;</p></li>
</ul>

<h3>2018 å¹´åšå¥½è‡ªå·±</h3>

<ul>
<li><p>ç®€å•ä¸ä¼˜é›…æ­£äº¤, å†™æ¸…æ™°çš„ä»£ç , åšç®€å•çš„äº‹, Go ç»§ç»­è¶æ‰‹;</p></li>
<li><p>è®¤å‡†çš„äº‹æƒ…å°±å¹², ä¸éª„ä¸èº;</p></li>
<li><p>é€¼ä¸€ä¸‹è‡ªå·±;</p></li>
</ul>
 ]]></description> </item> </channel> </rss>